(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[11],{"6X5G":function(e,t,n){"use strict";(function(e,r,o){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};var s=function(){return(s=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function a(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(t){i(t)}}function a(e){try{c(r.throw(e))}catch(t){i(t)}}function c(e){e.done?o(e.value):new n((function(t){t(e.value)})).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function c(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"===typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(a){i=[6,a],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function u(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),o=0;for(t=0;t<n;t++)for(var i=arguments[t],s=0,a=i.length;s<a;s++,o++)r[o]=i[s];return r}var d=1,p=2,f=3,h=4,l=6,m=7,v=8,g=10,y=11;function b(e){return e.value&&e.value.constructor===Date||e.type===g||e.type===m?"timestamp":"number"===typeof e.value?"number":"string"===typeof e.value||e.type===d||e.type===h?"string":"object"===typeof e.value?"object":void 0}function S(e){return e.constructor===Date?"timestamp":"number"===typeof e?"number":"string"===typeof e?"string":"object"===typeof e?"object":"string"}function w(e){var t={},n=b(e);if("object"===n){var r=Object.keys(e.value).reduce((function(t,n){var r=S(e.value[n]);if("object"===r){var o=function e(t){return Object.keys(t).reduce((function(n,r){var o=S(t[r]);return n[r]="object"===o?{type:"object",description:"",context:{},composite:e(t[r])}:{type:o,description:"",context:{}},n}),{})}(e.value[n]);t[n]={type:"object",description:"",context:{},composite:o}}else t[n]={type:r,description:"",context:{}};return t}),{});t.composite=r}return t.name=I(e.path.join("/")+"/"+e.name),t.type=n,t.description=e.description,t.context={},t}function I(e){return"undefined"!==typeof e&&e.length>0&&"/"!==e[0]?"/"+e:e}function M(e){return"timestamp"===b(e)?Date.now():function e(t){if("object"!==typeof t)return t;return Object.keys(t).reduce((function(n,r){var o=t[r];return"object"===typeof o&&o.constructor!==Date?n[r]=e(o):o.constructor===Date?n[r]=new Date(o).getTime():o.constructor===Boolean?n[r]=o.toString():n[r]=o,n}),{})}(e.value)}function j(e){var t=function e(t){return t.reduce((function(t,n){return t.concat(Array.isArray(n)?e(n):n)}),[])}(e.root.getAggregateState()),n=t.sort((function(e,t){return t.state-e.state}))[0];return{description:function(e){var t="";return e.forEach((function(e,n,r){var o=e.path.join(".");n===r.length-1?t+=o+"."+e.name+": "+e.description:t+=o+"."+e.name+": "+e.description+","})),t.length>100?t.slice(0,100)+"...":t}(t),value:n.state}}function _(e){var t=function e(t,r,o,i,s,a,c,u){var d={name:t,description:s,type:i||n(r),path:o,resolution:c,period:a,conflation:u};d.type===y&&(d.Composite=Object.keys(r).reduce((function(t,n){var i=r[n];return t.push(e(n,i,o)),t}),[]));return d}(e.name,e.value,e.path,e.type,e.description,e.period,e.resolution,e.conflation);function n(e){switch(e.constructor===Date?"timestamp":typeof e){case"string":return d;case"number":return p;case"timestamp":return m;case"object":return y}return 0}var r=["boolean","int","number","long","string","date","object"];return{id:e.id,instance:e.repo.instance,definition:t,value:function e(t,n){if(t&&t.constructor===Date)return{value:{type:r.indexOf("date"),value:t.valueOf(),isArray:!1}};if("object"===typeof t)return{CompositeValue:Object.keys(t).reduce((function(n,r){var o=e(t[r]);return o.InnerMetricName=r,n.push(o),n}),[])};var o=n?n.getValueType():void 0;return{value:{type:o=o||r.indexOf(typeof t),value:t,isArray:!1}}}(e.value,e)}}function k(e,t){var n;if(!e||"object"!==typeof e)throw new Error("Connection is required parameter");var r=e,o=t.heartbeatInterval||3e3,i=function(e,t){r.send("metrics",e,t)};function s(e){e.root&&0!==e.root.subSystems.length&&function e(t){c(t),t.subSystems.forEach((function(t){e(t)})),t.metrics.forEach((function(e){u(e)}))}(e.root)}function a(e){i("HeartbeatMetrics",{publishingInterval:o,instance:e.instance})}function c(e){void 0!==e.parent&&i("CreateMetricSystem",{id:e.id,instance:e.repo.instance,definition:{name:e.name,description:e.description,path:e.path}})}function u(e){i("CreateMetric",_(e))}return{createSystem:c,updateSystem:function(e,t){i("UpdateMetricSystem",{id:e.id,instance:e.repo.instance,state:t})},createMetric:u,updateMetric:function(e){i("UpdateMetric",_(e))},init:function(e){a(e),r.on("metrics","MetricsSnapshotRequest",(function(t){t.Instance===e.instance&&s(e)})),r.disconnected((function(){return clearInterval(n)})),"undefined"!==typeof window&&"undefined"===typeof window.htmlContainer&&(n=setInterval((function(){a(e)}),o))}}}var x=function(e,t,n){if(null===e||"object"!==typeof e)throw new Error("Missing definition");if(null===t||"object"!==typeof t)throw new Error("Missing parent");if(null===n||"object"!==typeof n)throw new Error("Missing transport")};function T(e,t,n,r){x(e,t,n);var o=n,i=r||"",s=t.path.slice(0);s.push(t.name);var a=e.name,c=e.description,u=e.period,d=e.resolution,p=e.conflation;var f={name:a,description:c,period:u,resolution:d,system:t,repo:t.repo,id:t.path+"/"+a,type:y,conflation:p,get value(){return i},get path(){return s},update:function(e){var t;t=e,Object.keys(i).forEach((function(e){"undefined"!==typeof t[e]&&(i[e]=t[e])})),o.updateMetric(f)},getValueType:function(){}};return o.createMetric(f),f}function R(e,t,n,r,o){if(!t)throw new Error("Repository is required");if(!n)throw new Error("Transport is required");var i,s,a=n,c=e,u=o||"",b=t,S=r,w=function e(t){if(!t||!t.parent)return[];var n=e(t.parent);return n.push(t.name),n}(r),I={},M=(s="/",((i=w)&&i.length>0?i.join(s):"")+e),j=t.identity,_=t.root,k=[],A=[];function E(e,t,n,r){var o=function(e){var t={};if("string"===typeof e?t.name=e:t=e,void 0===t.name)throw new Error("Metric name is required");return t}(e),i=A.filter((function(e){return e.name===o.name}));if(i.length>0){var s=i[0];if(s.type!==t)throw new Error("A metric named "+o.name+" is already defined with different type.");return"undefined"!==typeof n&&s.update(n),s}var a=r(o);return A.push(a),a}var O={get name(){return c},get description(){return u},get repo(){return b},get parent(){return S},path:w,id:M,identity:j,root:_,get subSystems(){return k},get metrics(){return A},subSystem:function(e,t){if(!e||0===e.length)throw new Error("name is required");var n=k.filter((function(t){return t.name===e}));if(n.length>0)return n[0];var r=R(e,b,a,O,t);return k.push(r),r},getState:function(){return I},setState:function(e,t){I={state:e,description:t},a.updateSystem(O,I)},stringMetric:function(e,t){return E.call(O,e,d,t,(function(e){return function(e,t,n,r){x(e,t,n);var o=n,i=r||"",s=t.path.slice(0);s.push(t.name);var a=e.name,c=e.description,u=e.period,p=e.resolution,f=e.conflation,h={name:a,description:c,period:u,resolution:p,system:t,repo:t.repo,id:t.path+"/"+a,conflation:f,get value(){return i},get path(){return s},type:d,update:function(e){i=e,o.updateMetric(h)},getValueType:function(){}};return o.createMetric(h),h}(e,O,a,t)}))},statisticsMetric:function(e,t){return E.call(this,e,l,t,(function(e){return function(e,t,n,r){x(e,t,n);var o=n,i=r||"",s=t.path.slice(0);s.push(t.name);var a=e.name,c=e.description,u=e.period,d=e.resolution,p=e.conflation,f={name:a,description:c,period:u,resolution:d,system:t,repo:t.repo,id:t.path+"/"+a,type:l,conflation:p,get value(){return i},get path(){return s},update:function(e){i=e,o.updateMetric(f)},getValueType:function(){}};return o.createMetric(f),f}(e,O,a,t)}))},rateMetric:function(e,t){return E.call(this,e,h,t,(function(e){return function(e,t,n,r){x(e,t,n);var o=n,i=r||"",s=t.path.slice(0);s.push(t.name);var a=e.name,c=e.description,u=e.period,d=e.resolution,p=e.conflation,f={name:a,description:c,period:u,resolution:d,system:t,repo:t.repo,id:t.path+"/"+a,type:h,conflation:p,get value(){return i},get path(){return s},update:function(e){i=e,o.updateMetric(f)},getValueType:function(){}};return o.createMetric(f),f}(e,O,a,t)}))},timestampMetric:function(e,t){return E.call(this,e,m,t,(function(e){return function(e,t,n,r){x(e,t,n);var o=n,i=r||"",s=t.path.slice(0);s.push(t.name);var a=e.name,c=e.description,u=e.period,d=e.resolution,p=e.conflation;function f(e){i=e,o.updateMetric(h)}var h={name:a,description:c,period:u,resolution:d,system:t,repo:t.repo,id:t.path+"/"+a,type:m,conflation:p,get value(){return i},get path(){return s},update:f,now:function(){f(new Date)},getValueType:function(){}};return o.createMetric(h),h}(e,O,a,t)}))},timespanMetric:function(e,t){return E.call(this,e,g,t,(function(e){return function(e,t,n,r){x(e,t,n);var o=n,i=r||"",s=t.path.slice(0);s.push(t.name);var a=e.name,c=e.description,u=e.period,d=e.resolution,p=e.conflation;function f(e){i=e,o.updateMetric(h)}var h={name:a,description:c,period:u,resolution:d,system:t,repo:t.repo,id:t.path+"/"+a,type:g,conflation:p,get value(){return i},get path(){return s},update:f,start:function(){f(!0)},stop:function(){f(!1)},getValueType:function(){}};return o.createMetric(h),h}(e,O,a,t)}))},objectMetric:function(e,t){return E.call(this,e,y,t,(function(e){return T(e,O,a,t)}))},addressMetric:function(e,t){return E.call(this,e,v,t,(function(e){return function(e,t,n,r){x(e,t,n);var o=n,i=r||"",s=t.path.slice(0);s.push(t.name);var a=e.name,c=e.description,u=e.period,d=e.resolution,p=t,f=t.repo,h=e.conflation,l={name:a,description:c,period:u,resolution:d,system:p,repo:f,id:t.path+"/"+a,type:v,conflation:h,get value(){return i},get path(){return s},update:function(e){i=e,o.updateMetric(l)},getValueType:function(){}};return o.createMetric(l),l}(e,O,a,t)}))},countMetric:function(e,t){return E.call(this,e,f,t,(function(e){return function(e,t,n,r){x(e,t,n);var o=n,i=r||0,s=t.path.slice(0);s.push(t.name);var a=e.name,c=e.description,u=e.period,d=e.resolution,p=e.conflation;function h(e){i=e,o.updateMetric(m)}function l(e){h(i+e)}var m={name:a,description:c,period:u,resolution:d,system:t,repo:t.repo,id:t.path+"/"+a,type:f,conflation:p,get path(){return s},get value(){return i},update:h,getValueType:function(){},incrementBy:l,increment:function(){l(1)},decrement:function(){l(-1)},decrementBy:function(e){l(-1*e)}};return o.createMetric(m),m}(e,O,a,t)}))},numberMetric:function(e,t){return E.call(O,e,p,t,(function(e){return function(e,t,n,r){x(e,t,n);var o=n,i=t.path.slice(0),s=r||0,a=e.name,c=e.description,u=e.period,d=e.resolution,f=e.conflation,h=t,l=t.repo,m=t.path+"/"+a,v=p;function g(e){s=e,o.updateMetric(b)}function y(e){g(s+e)}i.push(t.name);var b={name:a,description:c,period:u,resolution:d,system:h,repo:l,id:m,conflation:f,get value(){return s},type:v,get path(){return i},update:g,getValueType:function(){},incrementBy:y,increment:function(){y(1)},decrement:function(){y(-1)},decrementBy:function(e){y(-1*e)}};return o.createMetric(b),b}(e,O,a,t)}))},getAggregateState:function(){var e=[];return Object.keys(I).length>0&&e.push({name:c,path:w,state:I.state,description:I.description}),k.forEach((function(t){var n=t.getAggregateState();n.length>0&&e.push.apply(e,n)})),e}};return a.createSystem(O),O}var A=function(e){var t={connection:e.connection,identity:e.identity,logger:e.logger,heartbeatInterval:e.heartbeatInterval,settings:{},clickStream:e.clickStream};if(!t.connection||"object"!==typeof t.connection)throw new Error("Connection is required parameter");return function(e,t){if(!e.identity)throw new Error("Identity missing from metrics configuration");if(!e.identity.service||"string"!==typeof e.identity.service)throw new Error("Service missing or invalid in metrics identity configuration");if(!e.identity.system||"string"!==typeof e.identity.system)throw new Error("System missing or invalid in metrics identity configuration");if(!e.identity.instance||"string"!==typeof e.identity.instance)throw new Error("Instance missing or invalid in metrics identity configuration");var n,r={identity:e.identity,instance:e.identity.system+"/"+e.identity.service+"/"+e.identity.instance,get root(){return n}};return t.init(r),function(e,t){if("undefined"!==typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!==typeof document){var n=e.subSystem("ClickStream"),r=function(e){if(e.target){var t=e.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:e.target?t.className:"",id:t.id,type:"<"+t.tagName.toLowerCase()+">",href:t.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",r):document.attachEvent("onclick",r)}e.stringMetric("StartTime",(new Date).toString());var o=e.stringMetric("StartURL",""),i=e.stringMetric("AppName","");if("undefined"!==typeof window){if("undefined"!==typeof window.location){var s=window.location.href;o.update(s)}"undefined"!==typeof window.glue42gd&&i.update(window.glue42gd.appName)}}(n=R("",r,t),e.clickStream||void 0===e.clickStream),r}(t,3===t.connection.protocolVersion?function(e,t){if(!e||"object"!==typeof e)throw new Error("Connection is required parameter");var n,r,o=function(e){i(e.root)},i=function(e){a(e),e.metrics.forEach((function(e){c(e)})),e.subSystems.forEach((function(e){i(e)}))},a=function(e){void 0!==e.parent&&n.then((function(){var t={type:"define",metrics:[{name:I(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};r.send(t)}))},c=function(e){var t=d(e);n.then((function(){var e={type:"define",metrics:[w(t)]};r.send(e),"undefined"!==typeof t.value&&u(t)}))},u=function(e){var t=M(e),n={type:"publish",values:[{name:I(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};r.send(n)},d=function(e){var t=s({},e);return"object"===typeof e.value&&null!==e.value&&(t.value=s({},e.value)),t};return{init:function(i){var s;n=new Promise((function(e){s=e})),(r=e.domain("metrics",t.logger)).onJoined((function(e){e||(s(),s=void 0);var t={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};r.send(t),e&&o(i)})),r.join(t.identity)},createSystem:a,updateSystem:function(t,o){n.then((function(){var n={type:"publish",values:[{name:I(t.path.join("/")+"/"+t.name+"/State"),value:{Description:o.description,Value:o.state},timestamp:Date.now()}]};r.send(n);var i=j(t),s={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:i.description,Value:i.value},timestamp:Date.now()}]};r.send(s)}))},createMetric:c,updateMetric:function(e){var t=d(e);n.then((function(){return u(t)}))}}}(t.connection,e):k(t.connection,e)).root};function E(e){if(e&&e.errorHandling&&"function"!==typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"===typeof e.errorHandling&&e.errorHandling,n={};function r(n,r){var o=n instanceof Error?n:new Error(n);if(t)t(o);else{var i='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+o.stack;if(e)switch(e.errorHandling){case"log":return console.error(i);case"silent":return;case"throw":throw new Error(i)}console.error(i)}}return{add:function(e,t){var r=n[e];return r||(r=[],n[e]=r),r.push(t),function(){var r=n[e];r&&(r=r.reduce((function(e,n,r){return n===t&&e.length===r||e.push(n),e}),[]),n[e]=r)}},execute:function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];var i=n[e];if(!i||0===i.length)return[];var s=[];return i.forEach((function(n){try{var o=n.apply(void 0,t);s.push(o)}catch(i){s.push(void 0),r(i,e)}})),s},clear:function(){n={}},clearKey:function(e){n[e]&&delete n[e]}}}E.default=E;var O=E,C=function(){function e(e){this.messageHandlers={},this.ids=1,this.registry=O(),this._connected=!1,this.isTrace=!1,this._settings=e,this.logger=e.logger,this.isTrace=this.logger.canPublish("trace")}return e.prototype.init=function(e,t){this._protocol=t,this._transport=e,this._transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this._transport.onMessage(this.handleTransportMessage.bind(this))},e.prototype.send=function(e,t,n,r,o){if(this._transport.isObjectBasedTransport){var i=this._protocol.createObjectMessage(e,t,n,r);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(i)),this._transport.sendObject(i,e,t,o)}var s=this._protocol.createStringMessage(e,t,n,r);return this.isTrace&&this.logger.trace(">> "+s+"}"),this._transport.send(s,e,t,o)},e.prototype.on=function(e,t,n){t=t.toLowerCase(),void 0===this.messageHandlers[t]&&(this.messageHandlers[t]={});var r=this.ids++;return this.messageHandlers[t][r]=n,{type:t,id:r}},e.prototype.off=function(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]},Object.defineProperty(e.prototype,"isConnected",{get:function(){return this._connected},enumerable:!0,configurable:!0}),e.prototype.connected=function(e){return this._connected&&e(this._settings.ws||this._settings.http),this.registry.add("connected",e)},e.prototype.disconnected=function(e){return this.registry.add("disconnected",e)},e.prototype.login=function(e,t){return a(this,void 0,void 0,(function(){return c(this,(function(n){switch(n.label){case 0:return[4,this._transport.open()];case 1:return n.sent(),[2,this._protocol.login(e,t)]}}))}))},e.prototype.reconnect=function(){return this._transport.reconnect()},e.prototype.logout=function(){this._protocol.logout(),this._transport.close()},e.prototype.loggedIn=function(e){return this._protocol.loggedIn(e)},Object.defineProperty(e.prototype,"protocolVersion",{get:function(){return this._settings.protocolVersion||1},enumerable:!0,configurable:!0}),e.prototype.toAPI=function(){var e=this;return{send:e.send.bind(e),on:e.on.bind(e),off:e.off.bind(e),login:e.login.bind(e),logout:e.logout.bind(e),loggedIn:e.loggedIn.bind(e),connected:e.connected.bind(e),disconnected:e.disconnected.bind(e),get protocolVersion(){return e.protocolVersion},reconnect:e.reconnect.bind(e)}},e.prototype.distributeMessage=function(e,t){var n=this,r=this.messageHandlers[t.toLowerCase()];void 0!==r&&Object.keys(r).forEach((function(t){var o=r[t];if(void 0!==o)try{o(e)}catch(i){n.logger.error("Message handler failed with "+i.stack)}}))},e.prototype.handleConnectionChanged=function(e){this._connected!==e&&(this._connected=e,e?this.registry.execute("connected"):this.registry.execute("disconnected"))},e.prototype.handleTransportMessage=function(e){var t;t="string"===typeof e?this._protocol.processStringMessage(e):this._protocol.processObjectMessage(e),this.isTrace&&this.logger.trace("<< "+JSON.stringify(t)),this.distributeMessage(t.msg,t.msgType)},e}();var N=1;var P,L,q,D={nextValue:function(){return(N=(9301*N+49297)%233280)/233280},seed:function(e){N=e}},F="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function U(){q=!1}function J(e){if(e){if(e!==P){if(e.length!==F.length)throw new Error("Custom alphabet for shortid must be "+F.length+" unique characters. You submitted "+e.length+" characters: "+e);var t=e.split("").filter((function(e,t,n){return t!==n.lastIndexOf(e)}));if(t.length)throw new Error("Custom alphabet for shortid must be "+F.length+" unique characters. These characters were not unique: "+t.join(", "));P=e,U()}}else P!==F&&(P=F,U())}function V(){return q||(q=function(){P||J(F);for(var e,t=P.split(""),n=[],r=D.nextValue();t.length>0;)r=D.nextValue(),e=Math.floor(r*t.length),n.push(t.splice(e,1)[0]);return n.join("")}())}var H={characters:function(e){return J(e),P},seed:function(e){D.seed(e),L!==e&&(U(),L=e)},lookup:function(e){return V()[e]},shuffled:V},B="object"===typeof window&&(window.crypto||window.msCrypto);var K=function(){if(!B||!B.getRandomValues)return 48&Math.floor(256*Math.random());var e=new Uint8Array(1);return B.getRandomValues(e),48&e[0]};var G=function(e,t){for(var n,r=0,o="";!n;)o+=e(t>>4*r&15|K()),n=t<Math.pow(16,r+1),r++;return o};var W=function(e){var t=H.shuffled();return{version:15&t.indexOf(e.substr(0,1)),worker:15&t.indexOf(e.substr(1,1))}};var Y=function(e){if(!e||"string"!==typeof e||e.length<6)return!1;for(var t=H.characters(),n=e.length,r=0;r<n;r++)if(-1===t.indexOf(e[r]))return!1;return!0},X=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e){var t,n,r=0;function o(){var e="",o=Math.floor(.001*(Date.now()-1459707606518));return o===n?t++:(t=0,n=o),e+=G(H.lookup,6),e+=G(H.lookup,r),t>0&&(e+=G(H.lookup,t)),e+=G(H.lookup,o)}e.exports=o,e.exports.generate=o,e.exports.seed=function(t){return H.seed(t),e.exports},e.exports.worker=function(t){return r=t,e.exports},e.exports.characters=function(e){return void 0!==e&&H.characters(e),H.shuffled()},e.exports.decode=W,e.exports.isValid=Y})),z=(X.generate,X.seed,X.worker,X.characters,X.decode,X.isValid,X);function Q(e,t,n,r,o){null==e&&(e="global"),r=r||["success"],o=o||["error"];var i,s=!1,a=!1,c=!1,u=O();t.disconnected((function(){c=!1,n.warn("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),t.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),p(i))})),t.on(e,"success",(function(e){return h(e)})),t.on(e,"error",(function(e){return f(e)})),t.on(e,"result",(function(e){return h(e)})),r&&r.forEach((function(n){t.on(e,n,(function(e){return h(e)}))})),o&&o.forEach((function(n){t.on(e,n,(function(e){return f(e)}))}));var d={};function p(t){return i=t,new Promise((function(r,o){if(s)r();else{var i;if("global"===e)i=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining "+e),i=m({type:"join",destination:e,domain:"global",options:t});i.then((function(){!function(){n.debug("did join "+e),s=!0;var t=a;a=!1,u.execute("onJoined",t)}(),r()})).catch((function(t){n.debug("error joining "+e+" domain: "+JSON.stringify(t)),o(t)}))}}))}function f(t){if(e===t.domain){var n=t.request_id,r=d[n];r&&r.error(t)}}function h(t){if(t.domain===e){var n=t.request_id,r=d[n];r&&r.success(t)}}function l(){return z()}function m(r,o,i){i=i||{},r.request_id=r.request_id||l(),r.domain=r.domain||e,i.skipPeerId||(r.peer_id=t.peerId);var s=r.request_id;return new Promise((function(a,c){d[s]={success:function(e){delete d[s],e._tag=o,a(e)},error:function(e){n.warn("GW error - "+JSON.stringify(e)+" for request "+JSON.stringify(r)),delete d[s],e._tag=o,c(e)}},t.send(e,e,r,void 0,i).catch((function(e){d[s].error({err:e})}))}))}return{join:p,leave:function(){"global"!==e&&(n.debug("stopping session "+e+"..."),m({type:"leave",destination:e,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(e){return s&&e(!1),u.add("onJoined",e)},onLeft:function(e){return s||e(),u.add("onLeft",e)},send:m,sendFireAndForget:function(n){n.request_id=n.request_id?n.request_id:l(),n.domain=n.domain||e,n.peer_id=t.peerId,t.send(e,e,n)},on:function(r,o){t.on(e,r,(function(t){if(t.domain===e)try{o(t)}catch(r){n.error("Callback  failed: "+r+" \n msg was: "+JSON.stringify(t))}}))},loggedIn:function(e){return t.loggedIn(e)},connected:function(e){return t.connected(e)},disconnected:function(e){return t.disconnected(e)},get peerId(){return t.peerId},get domain(){return e}}}var Z=function(){function e(){}return e.prototype.processStringMessage=function(e){var t=JSON.parse(e);return{msg:t,msgType:t.type}},e.prototype.createStringMessage=function(e,t,n,r){return JSON.stringify(n)},e.prototype.login=function(e){return Promise.resolve({application:void 0})},e.prototype.logout=function(){},e.prototype.loggedIn=function(e){return e(),function(){}},e.prototype.processObjectMessage=function(e){throw new Error("not supported")},e.prototype.createObjectMessage=function(e,t,n,r){throw new Error("not supported")},Object.defineProperty(e.prototype,"isLoggedIn",{get:function(){return!0},enumerable:!0,configurable:!0}),e}(),$=function(){function e(){}return e.getGDMajorVersion=function(){if("undefined"===typeof window)return-1;if(!window.glueDesktop)return-1;if(!window.glueDesktop.version)return-1;var e=Number(window.glueDesktop.version.substr(0,1));return isNaN(e)?-1:e},e.isNode=function(){if("undefined"!==typeof e._isNode)return e._isNode;try{e._isNode="[object process]"===Object.prototype.toString.call(r.process)}catch(t){e._isNode=!1}return e._isNode},e}(),ee=function(){function e(){var e=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(t,n){e.resolve=function(n){e.resolved=!0,t(n)},e.reject=function(t){e.rejected=!0,n(t)}}))}return e.delay=function(e){return new Promise((function(t){return setTimeout(t,e)}))},Object.defineProperty(e.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),e}(),te=$.isNode()?n("f3NI"):window.WebSocket,ne=function(){function e(e,t){this._running=!0,this._registry=O(),this.settings=e,this.logger=t}return e.prototype.onMessage=function(e){return this._registry.add("onMessage",e)},e.prototype.send=function(e,t,n,r){var o=this;return new Promise((function(t,n){r=r||{},o.waitForSocketConnection((function(){try{o.ws.send(e),t()}catch(r){n(r)}}),n,r.maxRetries,r.retryInterval)}))},e.prototype.open=function(){var e=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(t,n){e.waitForSocketConnection(t,n)}))},e.prototype.close=function(){this._running=!1,this.ws&&this.ws.close()},e.prototype.reconnect=function(){this.ws.close();var e=new ee;return this.waitForSocketConnection((function(){e.resolve()})),e.promise},e.prototype.onConnectedChanged=function(e){return this._registry.add("onConnectedChanged",e)},e.prototype.initiateSocket=function(){var e=this;this.logger.debug("initiating ws to "+this.settings.ws+"...");var t=new ee;return this.ws=new te(this.settings.ws),this.ws.onerror=function(t){var n="";try{n=JSON.stringify(t)}catch(o){var r=new WeakSet;n=JSON.stringify(t,(function(e,t){if("object"===typeof t&&null!==t){if(r.has(t))return;r.add(t)}return t}))}e.notifyStatusChanged(!1,n)},this.ws.onclose=function(){e.logger.info("ws closed"),e.notifyStatusChanged(!1)},this.ws.onopen=function(){e.logger.debug("ws opened"),e.notifyStatusChanged(!0),t.resolve()},this.ws.onmessage=function(t){e._registry.execute("onMessage",t.data)},t.promise},e.prototype.waitForSocketConnection=function(e,t,n,r){var o=this;if(e||(e=function(){}),t||(t=function(){}),void 0===r&&(r=this.settings.reconnectInterval),void 0!==n){if(0===n)return void t("wait for socket on "+this.settings.ws+" failed - no more retries left");this.logger.debug("will retry "+n+" more times (every "+r+" ms)")}if(this._running){var i=!1;if(!this.ws||this.ws.readyState>1)this.initiateSocket().then((function(){i||(i=!0,e())}));else if(1===this.ws.readyState)return e();setTimeout((function(){if(!i){i=!0;var s=void 0===n?void 0:n-1;o.waitForSocketConnection(e,t,s,r)}}),r)}else t("wait for socket on "+this.settings.ws+" failed - socket closed by user")},e.prototype.notifyStatusChanged=function(e,t){this._registry.execute("onConnectedChanged",e,t)},e}(),re=function(){function e(e){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var t=0,n=e;t<n.length;t++){var r=n[t];this.specs[r.name]=r,this.specsNames.push(r.name)}}return e.prototype.init=function(e){var t=this;this.connection=e;for(var n=0,r=this.specsNames;n<r.length;n++)for(var o=r[n],i=function(n){var r=s.subsRefCount[n];if(r||(r=0),r+=1,s.subsRefCount[n]=r,r>1)return"continue";var o=e.on("glue-core",n,(function(e){return t.processMessage(n,e)}));s.subs[n]=o},s=this,a=0,c=this.specs[o].types;a<c.length;a++){i(c[a])}},e.prototype.processMessage=function(e,t){if(!this.isDone&&t)for(var n=0,r=this.specsNames;n<r.length;n++){var o=r[n];if(-1!==this.specs[o].types.indexOf(e)){var i=this.messages[o]||[];this.messages[o]=i,i.push(t)}}},e.prototype.drain=function(e,t){t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(var n=0,r=this.specs[e].types;n<r.length;n++){var o=r[n];this.subsRefCount[o]-=1,this.subsRefCount[o]<=0&&(this.connection.off(this.subs[o]),delete this.subs[o],delete this.subsRefCount[o])}delete this.specs[e],this.specs.length||(this.isDone=!0)},e}(),oe=function(e){function t(t){var n=e.call(this,t)||this;return t.replaySpecs&&t.replaySpecs.length&&(n.replayer=new re(t.replaySpecs)),n}return function(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}(t,e),t.prototype.init=function(t,n){e.prototype.init.call(this,t,n),this.replayer&&this.replayer.init(this),this.gw3Protocol=n},t.prototype.toAPI=function(){var t=this,n=e.prototype.toAPI.call(this);return{domain:t.domain.bind(t),get peerId(){return t.peerId},get token(){return t.token},get info(){return t.info},get resolvedIdentity(){return t.resolvedIdentity},get availableDomains(){return t.availableDomains},get gatewayToken(){return t.gatewayToken},get replayer(){return t.replayer},on:n.on,send:n.send,off:n.off,login:n.login,logout:n.logout,loggedIn:n.loggedIn,connected:n.connected,disconnected:n.disconnected,authToken:t.authToken.bind(t),reconnect:n.reconnect,get protocolVersion(){return n.protocolVersion}}},t.prototype.domain=function(e,t,n,r){return this.gw3Protocol.domain(e,t,n,r)},t.prototype.authToken=function(){return this.gw3Protocol.authToken()},Object.defineProperty(t.prototype,"isConnected",{get:function(){return this._protocol.isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.connected=function(e){var t=this;return this._protocol.loggedIn((function(){e(t._settings.ws)}))},t}(C),ie=function(){function e(e,t){this._connection=e,this._settings=t}return Object.defineProperty(e.prototype,"isLoggedIn",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.processStringMessage=function(e){var t=JSON.parse(e);return{msg:t.message,msgType:t.type}},e.prototype.createStringMessage=function(e,t,n,r){return JSON.stringify({type:t,message:n,id:r})},e.prototype.login=function(e){var t=this;return new Promise((function(e,n){var r={retryInterval:t._settings.reconnectInterval,maxRetries:t._settings.reconnectAttempts};t._connection.send("hello","hello",{},null,r).then((function(){return e({application:void 0})})).catch(n)}))},e.prototype.logout=function(){},e.prototype.loggedIn=function(e){return e(),function(){}},e.prototype.processObjectMessage=function(e){throw new Error("not supported")},e.prototype.createObjectMessage=function(e,t,n,r){throw new Error("not supported")},e}(),se=function(){function e(){this.connectionId=Math.floor(1e10*Math.random()).toString()}return e.prototype.send=function(e,t,n){return"metrics"===t?window.htmlContainer.metricsFacade.send(n,e):"log"===t&&window.htmlContainer.loggingFacade.send(n,e),Promise.resolve(void 0)},e.prototype.onConnectedChanged=function(e){e(!0)},e.prototype.onMessage=function(e){},e.prototype.close=function(){},e.prototype.open=function(){return Promise.resolve()},e.prototype.reconnect=function(){return Promise.resolve()},e}(),ae=function(){function e(e,t){var n=this;this.registry=O(),this.gw=e,this.logger=t,this.gw.connect((function(e,t){n.messageHandler(t)})).then((function(e){n.client=e}))}return Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")},e.prototype.send=function(e,t,n){return Promise.reject("not supported")},e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.onConnectedChanged=function(e){e(!0)},e.prototype.close=function(){},e.prototype.open=function(){return Promise.resolve()},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.messageHandler=function(e){this.registry.execute("onMessage",e)},e}(),ce=function(t){(t=t||{}).reconnectAttempts=t.reconnectAttempts||10,t.reconnectInterval=t.reconnectInterval||500;var n=new C(t),r=t.logger;if(!r)throw new Error("please pass a logger object");var o=new Z,i=new se;if(2!==t.gdVersion||t.force){if(t.gw&&t.gw.facade&&3===t.protocolVersion)i=new ae(t.gw.facade,r.subLogger("inproc"));else{if(void 0===t.ws)throw new Error("No connection information specified");i=new ne(t,r.subLogger("ws"))}if(3===t.protocolVersion){var s=new oe(t),u=function(t,n,r){var o,i,s,u="#T42_DATE#".length,d=u+1,p="#T42_DATE#"[0],f=O(),h=!1,l=!0,m=!0,v=3,g=[];function y(e){(h=e)&&f.execute("onLoggedIn")}return t.disconnected(function e(){if(y(!1),l&&m){if(v<=0)return;v--}if(r.debug("disconnected - will try new login?"+l),l){if(!s)throw new Error("no login info");t.login(s,!0).catch((function(){setTimeout(e,1e3)}))}}.bind(this)),function e(){l&&(h&&t.send("","",{type:"ping"}),i=setTimeout(e,3e4))}(),{processStringMessage:function(e){var t=JSON.parse(e,(function(e,t){if("string"!==typeof t)return t;if(t.length<d)return t;if(t[0]!==p)return t;if("#T42_DATE#"!==t.substring(0,u))return t;try{var n=parseInt(t.substring(u,t.length),10);return isNaN(n)?t:new Date(n)}catch(r){return t}}));return{msg:t,msgType:t.type}},createStringMessage:function(e,t,n,r){var o=Date.prototype.toJSON;try{return Date.prototype.toJSON=function(){return"#T42_DATE#"+this.getTime()},JSON.stringify(n)}finally{Date.prototype.toJSON=o}},createObjectMessage:function(e,t,n,r){return n},processObjectMessage:function(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}},login:function(i,u){return a(this,void 0,void 0,(function(){var a,d,p,f,h,v,g,b,S,w;return c(this,(function(c){switch(c.label){case 0:if(r.debug("logging in..."),(s=i)||(s={username:"",password:""}),l=!0,a={},t.gatewayToken=i.gatewayToken,!i.gatewayToken)return[3,5];if(!u)return[3,4];c.label=1;case 1:return c.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return b=c.sent(),i.token=b,[3,4];case 3:return d=c.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null===d||void 0===d?void 0:d.message)||d)),[3,4];case 4:return a.method="gateway-token",a.token=i.gatewayToken,t.gatewayToken=i.gatewayToken,[3,8];case 5:return"sspi"!==i.flowName?[3,7]:(a.provider="win",a.method="access-token",p=a,[4,i.flowCallback(i.sessionId,null)]);case 6:return p.token=c.sent().data.toString("base64"),[3,8];case 7:if(i.token)a.method="access-token",a.token=i.token;else{if(!i.username)throw new Error("invalid auth message"+JSON.stringify(i));a.method="secret",a.login=i.username,a.secret=i.password}c.label=8;case 8:f={type:"hello",identity:n.identity,authentication:a},i.sessionId&&(f.request_id=i.sessionId),o=Q("global",t,r,["welcome","token","authentication-request"]),h={skipPeerId:!0},m&&(h.retryInterval=n.reconnectInterval,h.maxRetries=n.reconnectAttempts),c.label=9;case 9:c.trys.push([9,16,17,18]),v=void 0,c.label=10;case 10:return[4,o.send(f,void 0,h)];case 11:return"authentication-request"!==(g=c.sent()).type?[3,13]:(b=e.from(g.authentication.token,"base64"),S=f.authentication,[4,i.flowCallback(i.sessionId,b)]);case 12:return S.token=c.sent().data.toString("base64"),f.request_id=i.sessionId,[3,10];case 13:if("welcome"===g.type)return v=g,[3,15];throw"error"===g.type?new Error("Authentication failed: "+g.reason):new Error("Unexpected message type during authentication: "+g.type);case 14:return[3,10];case 15:return m=!1,r.debug("login successful with PeerId "+v.peer_id),t.peerId=v.peer_id,t.resolvedIdentity=v.resolved_identity,t.availableDomains=v.available_domains,v.options&&(t.token=v.options.access_token,t.info=v.options.info),y(!0),[2,v.resolved_identity];case 16:throw w=c.sent(),r.error("error sending hello message - "+(w.message||w.msg||w.reason||w)),w;case 17:return i&&i.flowCallback&&i.sessionId&&i.flowCallback(i.sessionId,null),[7];case 18:return[2]}}))}))},logout:function(){r.debug("logging out..."),l=!1,i&&clearTimeout(i),g.forEach((function(e){e.leave()}))},loggedIn:function(e){return h&&e(),f.add("onLoggedIn",e)},domain:function(e,n,r,o){var i=g.filter((function(t){return t.domain===e}))[0];return i||(i=Q(e,t,n,r,o),g.push(i)),i},authToken:function(){return this.globalDomain?o.send({type:"create-token"}).then((function(e){return e.token})):Promise.reject(new Error("no global domain session"))},get isLoggedIn(){return h}}}(s,t,r.subLogger("gw3"));return s.init(i,u),s.toAPI()}o=new ie(n,t)}return n.init(i,o),n.toAPI()},ue=function(){function e(){}return e.canPublish=function(t,n){return e.order.indexOf(t)>=e.order.indexOf(n)},e.off="off",e.trace="trace",e.debug="debug",e.info="info",e.warn="warn",e.error="error",e.order=[e.trace,e.debug,e.info,e.warn,e.error,e.off],e}(),de=function(){function e(e,t,n,r){this._subloggers=[],this.logFn=console,this.customLogFn=!1,this._name=e,this._parent=t,this._path=t?t.path+"."+e:e,this._loggerFullName="["+this._path+"]","undefined"!==typeof n&&n&&this.metricsLevel("warn",n.subSystem(e)),this.includeTimeAndLevel=!r,r&&(this.logFn=r,this.customLogFn=!0)}return Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this._path},enumerable:!0,configurable:!0}),e.prototype.subLogger=function(t){var n=this._subloggers.filter((function(e){return e.name===t}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(e){if(e===t)throw new Error("This sub logger name is not allowed.")}));var r=new e(t,this,void 0,this.customLogFn?this.logFn:void 0);return this._subloggers.push(r),r},e.prototype.publishLevel=function(e){var t;return null!==e&&void 0!==e&&(this._publishLevel=e),this._publishLevel||(null===(t=this._parent)||void 0===t?void 0:t.publishLevel())},e.prototype.consoleLevel=function(e){var t;return null!==e&&void 0!==e&&(this._consoleLevel=e),this._consoleLevel||(null===(t=this._parent)||void 0===t?void 0:t.consoleLevel())},e.prototype.metricsLevel=function(e,t){var n;if(null!==e&&void 0!==e&&(this._metricLevel=e),void 0!==t){if("object"!==typeof t||"function"!==typeof t.objectMetric)throw new Error("Please specify metric system");this._metricSystem=t}return this._metricLevel||(null===(n=this._parent)||void 0===n?void 0:n.metricsLevel())},e.prototype.log=function(e,t){this.publishMessage(t||ue.info,e)},e.prototype.trace=function(e){this.log(e,ue.trace)},e.prototype.debug=function(e){this.log(e,ue.debug)},e.prototype.info=function(e){this.log(e,ue.info)},e.prototype.warn=function(e){this.log(e,ue.warn)},e.prototype.error=function(e){this.log(e,ue.error)},e.prototype.toAPIObject=function(){return{name:this.name,subLogger:this.subLogger.bind(this),publishLevel:this.publishLevel.bind(this),consoleLevel:this.consoleLevel.bind(this),metricsLevel:this.metricsLevel.bind(this),log:this.log.bind(this),trace:this.trace.bind(this),debug:this.debug.bind(this),info:this.info.bind(this),warn:this.warn.bind(this),error:this.error.bind(this),canPublish:this.canPublish.bind(this)}},e.prototype.canPublish=function(e){return ue.canPublish(e,this.consoleLevel())},e.prototype.publishMessage=function(t,n){var r,o,i=this._loggerFullName;if(t===ue.error){var s=new Error;s.stack&&(n=n+"\n"+s.stack.split("\n").slice(3).join("\n"))}if(ue.canPublish(t,this.consoleLevel())){var a="";if(this.includeTimeAndLevel){var c=new Date;a="["+(c.getHours()+":"+c.getMinutes()+":"+c.getSeconds()+":"+c.getMilliseconds())+"] ["+t+"] "}var u=""+a+i+": "+n;switch(t){case ue.trace:this.logFn.debug(u);break;case ue.debug:this.logFn.debug?this.logFn.debug(u):this.logFn.log(u);break;case ue.info:this.logFn.info(u);break;case ue.warn:this.logFn.warn(u);break;case ue.error:this.logFn.error(u)}}if(ue.canPublish(t,this.publishLevel())){var d=e.GetConnection&&e.GetConnection()&&e.GetConnection().protocolVersion>=3;(null===(r=e.Interop)||void 0===r?void 0:r.methods({name:e.InteropMethodName}).length)>0&&(null===(o=e.Interop)||void 0===o||o.invoke(e.InteropMethodName,{msg:""+n,logger:i,level:t})),e.GetConnection&&!d&&e.GetConnection().send("log","LogMessage",{instance:e.Instance,level:ue.order.indexOf(t),logger:i,message:n})}ue.canPublish(t,this.metricsLevel())&&void 0!==this._metricSystem&&(this._metricSystem.objectMetric("LogMessage",{Level:t,Logger:i,Message:n,Time:new Date}),t===ue.error&&this._metricSystem.setState(100,n))},e.InteropMethodName="T42.AppLogger.Log",e}(),pe=function(){function e(e,t){var n=this;this.wrapped={getMethods:fe,getStreams:he},this.refreshWrappedObject(e),t&&(t.loggedIn((function(){n.refresh(t)})),this.refresh(t))}return e.prototype.unwrap=function(){return this.wrapped},e.prototype.refresh=function(e){if(e){var t=null===e||void 0===e?void 0:e.resolvedIdentity,n=Object.assign({},null!==t&&void 0!==t?t:{},{peerId:null===e||void 0===e?void 0:e.peerId});this.refreshWrappedObject(n)}},e.prototype.refreshWrappedObject=function(e){var t,n,r;this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=null!==(t=e.application)&&void 0!==t?t:z(),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=null!==(r=null!==(n=e.pid)&&void 0!==n?n:e.process)&&void 0!==r?r:Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=!0,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId},e}();function fe(){var e;return null===(e=pe.API)||void 0===e?void 0:e.methodsForInstance(this)}function he(){var e;return null===(e=pe.API)||void 0===e?void 0:e.methodsForInstance(this).filter((function(e){return e.supportsStreaming}))}function le(e,t,n){if("function"!==typeof t&&"function"!==typeof n)return e;"function"!==typeof t?t=function(){}:"function"!==typeof n&&(n=function(){}),e.then(t,n)}var me=function(){function e(e,t,n){this.instance=e,this.helpers=t,this.agmFacade=n,this.protocolVersion=this.agmFacade.protocolVersion}return e.prototype.register=function(e,t){var n=this.helpers.stringToObject(e,"name");return this.helpers.validateMethodInfo(n),this.protocolVersion&&this.protocolVersion>=3?this.agmFacade.register(JSON.stringify(n),t,!0):this.agmFacade.register(JSON.stringify(n),(function(e,n){var r=t(JSON.parse(e),n);return JSON.stringify(r)})),Promise.resolve()},e.prototype.registerAsync=function(e,t){if(!this.agmFacade.registerAsync)throw new Error("not supported in that version of HtmlContainer");var n=this.helpers.stringToObject(e,"name");return this.helpers.validateMethodInfo(n),this.agmFacade.registerAsync(n,(function(e,n,r){t(e,n,(function(e){r.success(e)}),(function(e){r.error(e)}))})),Promise.resolve()},e.prototype.unregister=function(e){this.agmFacade.unregister(JSON.stringify(this.helpers.stringToObject(e,"name")))},e.prototype.invoke=function(e,t,n,r,o,i){var s=this;return le(new Promise((function(o,i){if(void 0===t&&(t={}),"object"!==typeof t&&i({message:"The method arguments must be an object."}),void 0===r&&(r={}),n=s.helpers.targetArgToObject(n),s.agmFacade.invoke2)s.agmFacade.invoke2(JSON.stringify(s.helpers.stringToObject(e,"name")),t,JSON.stringify(n),JSON.stringify(r),(function(e){o(e)}),(function(e){i(e)}));else{var a,c;a=function(e){var t=JSON.parse(e);o(t)},c=function(e){var t=JSON.parse(e);i(t)},s.agmFacade.invoke(JSON.stringify(s.helpers.stringToObject(e,"name")),JSON.stringify(t),JSON.stringify(n),JSON.stringify(r),a,c)}})),o,i)},e.prototype.createStream=function(e,t,n,r){var o=this;return le(new Promise((function(n,r){"string"===typeof e&&(e={name:e,getServers:function(){return[]}}),t||(t={subscriptionRequestHandler:void 0,subscriptionAddedHandler:void 0,subscriptionRemovedHandler:void 0}),o.agmFacade.createStream2(JSON.stringify(e),t.subscriptionRequestHandler,t.subscriptionAddedHandler,t.subscriptionRemovedHandler,(function(e){n(e)}),(function(e){r(e)}))})),n,r)},e.prototype.subscribe=function(e,t,n,r){var o=this;return le(new Promise((function(n,r){var i;"undefined"===typeof e&&r("method definition param is required"),void 0===t&&(t={}),t.args=JSON.stringify(t.arguments||{}),t.target=o.helpers.targetArgToObject(t.target),i="string"===typeof e?e:e.name,o.agmFacade.subscribe2(i,JSON.stringify(t),(function(e){n(e)}),(function(e){r(e)}))})),n,r)},e.prototype.servers=function(e){var t=this,n=this.agmFacade.servers(JSON.stringify(this.helpers.stringToObject(e,"name")));return this.helpers.agmParse(n).map((function(e){return t.transformServerObject(e)}))},e.prototype.methods=function(e){var t=this,n=this.agmFacade.methods(JSON.stringify(this.helpers.stringToObject(e,"name")));return this.helpers.agmParse(n).map((function(e){return t.transformMethodObject(e)}))},e.prototype.methodAdded=function(e){var t=this,n=!0;return this.agmFacade.methodAdded((function(r){n&&e(t.transformMethodObject(r))})),function(){n=!1}},e.prototype.methodRemoved=function(e){var t=this,n=!0;return this.agmFacade.methodRemoved((function(r){n&&e(t.transformMethodObject(r))})),function(){n=!1}},e.prototype.serverAdded=function(e){var t=this,n=!0;return this.agmFacade.serverAdded((function(r){n&&e(t.transformServerObject(r))})),function(){n=!1}},e.prototype.serverRemoved=function(e){var t=this,n=!0;return this.agmFacade.serverRemoved((function(r){n&&e(t.transformServerObject(r))})),function(){n=!1}},e.prototype.serverMethodAdded=function(e){var t=this,n=!0;return this.agmFacade.serverMethodAdded((function(r){n&&e({server:t.transformServerObject(r.server),method:t.transformMethodObject(r.method)})})),function(){n=!1}},e.prototype.serverMethodRemoved=function(e){var t=this,n=!0;return this.agmFacade.serverMethodRemoved((function(r){n&&e({server:t.transformServerObject(r.server),method:t.transformMethodObject(r.method)})})),function(){n=!1}},e.prototype.methodsForInstance=function(e){var t=this.agmFacade.methodsForInstance(JSON.stringify(e));return this.helpers.agmParse(t).map(this.transformMethodObject)},e.prototype.transformMethodObject=function(e){var t=this;if(e)return e.displayName||(e.displayName=e.display_name),e.objectTypes||(e.objectTypes=e.object_types),e.getServers=function(){return t.servers(e.name)},e},e.prototype.transformServerObject=function(e){var t=this;if(e)return e.getMethods=function(){return t.methodsForInstance(e)},e.getStreams=function(){return t.methodsForInstance(e).filter((function(e){return e.supportsStreaming}))},e},e}(),ve=function(){function e(e){this.facade=e,this.dateTimeIdentifier=e.jsonValueDatePrefix,this.lenOfIdentifier=this.dateTimeIdentifier.length}return e.prototype.agmParse=function(e){var t=this;return JSON.parse(e,(function(e,n){if("string"!==typeof n)return n;if(n[0]!==t.dateTimeIdentifier[0])return n;if(0!==n.indexOf(t.dateTimeIdentifier))return n;var r=n.substr(t.lenOfIdentifier);return new Date(parseFloat(r))}))},e.prototype.targetArgToObject=function(e){var t=this;if("string"===typeof(e=e||"best")){if("all"!==e&&"best"!==e)throw new Error(e+" is not a valid target. Valid targets are 'all' and 'best'");return{target:e}}return Array.isArray(e)||(e=[e]),{serverFilter:e=e.map((function(e){return t.convertInstanceToRegex(e)}))}},e.prototype.convertInstanceToRegex=function(e){var t={};return Object.keys(e).forEach((function(n){var r=e[n];t[n]=r,"undefined"!==typeof r&&null!==r&&("string"===typeof r&&""!==r?t[n]="^"+e[n]+"$":e[n].constructor===RegExp?t[n]=e[n].source:t[n]=e[n])})),t},e.prototype.validateMethodInfo=function(e){if("undefined"===typeof e)throw Error("methodInfo is required argument");if(!e.name)throw Error("methodInfo object must contain name property");e.objectTypes&&(e.object_types=e.objectTypes),e.displayName&&(e.display_name=e.displayName)},e.prototype.stringToObject=function(e,t){if("string"===typeof e){var n={};return n[t]=e,n}return e},e}();var ge=function(e){if(void 0!==e&&void 0!==e.metrics){e.metrics.metricsIdentity=e.metrics.identity;var t={metricsIdentity:e.metrics.metricsIdentity,path:e.metrics.path};e.metrics=t}return delete e.logger,JSON.stringify(e)};function ye(e){return"object"!==typeof e&&(e={}),{application:e.ApplicationName,environment:e.Environment,machine:e.MachineName,pid:e.ProcessId,region:e.Region,service:e.ServiceName,user:e.UserName,started:e.ProcessStartTime}}function be(e){if("number"!==typeof e||isNaN(e))return!1;return 32===(32&e)}function Se(e){return{ApplicationName:e.application,ProcessId:e.pid,MachineName:e.machine,UserName:e.user,Environment:e.environment,Region:e.region}}var we,Ie=function(){function e(e,t){this.connection=e,this.instance=t}return e.prototype.isStreamMsg=function(e,t){return e&&e.EventStreamAction&&0!==e.EventStreamAction&&"object"===typeof t&&!0===t.definition.supportsStreaming},e.prototype.pushData=function(e,t,n){var r=this;if("object"===typeof e&&Array.isArray(e.protocolState.branchKeyToStreamIdMap)){if("object"!==typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"===typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=null);var o=e.protocolState.branchKeyToStreamIdMap.filter((function(e){return null===n||Boolean(e)&&"string"===typeof e.key&&n.indexOf(e.key)>=0})).map((function(e){return e.streamId})),i=Se(this.instance);o.forEach((function(n){r.sendResult({EventStreamAction:5,EventStreamSubject:e.protocolState.globalEventStreamSubject,MethodName:e.protocolState.method.Method.Name,MethodRequestSubject:e.protocolState.method.MethodRequestSubject,ResultContextJson:t,Server:i,StreamId:n})}))}},e.prototype.closeAllSubscriptions=function(e,t){var n=this;if("object"===typeof e&&Array.isArray(e.protocolState.branchKeyToStreamIdMap)){var r=e.protocolState.branchKeyToStreamIdMap;"string"===typeof t&&(r=e.protocolState.branchKeyToStreamIdMap.filter((function(e){return"object"===typeof e&&e.key===t}))),r.forEach((function(t){var r=t.streamId;n.sendResult({EventStreamAction:2,EventStreamSubject:e.protocolState.globalEventStreamSubject,MethodName:e.protocolState.method.Method.Name,MethodRequestSubject:e.protocolState.method.MethodRequestSubject,Server:Se(n.instance),StreamId:r,Status:0})}))}},e.prototype.getBranchList=function(e){return"object"!==typeof e?[]:this.getUniqueBranchNames(e)},e.prototype.getSubscriptionList=function(e,t){if("object"!==typeof e)return[];return"string"!==typeof t?e.protocolState.subscriptions:e.protocolState.subscriptions.filter((function(e){return e.branchKey===t}))},e.prototype.onSubAdded=function(e){"function"===typeof e&&(this.subAddedHandler=e)},e.prototype.onSubRemoved=function(e){"function"===typeof e&&(this.subRemovedHandler=e)},e.prototype.onSubRequest=function(e){"function"===typeof e&&(this.requestHandler=e)},e.prototype.generateNewStreamId=function(e){return"streamId-jsb_of_"+e+"__by_"+Se(this.instance).ApplicationName+"_"+z()},e.prototype.rejectRequest=function(e,t,n){"string"!==typeof n&&(n="");var r=e.msg;this.sendResult({EventStreamAction:2,EventStreamSubject:t.protocolState.globalEventStreamSubject,MethodName:t.protocolState.method.Method.Name,MethodRequestSubject:t.protocolState.method.MethodRequestSubject,MethodResponseSubject:r.MethodResponseSubject,MethodVersion:t.protocolState.method.Method.Version,ResultMessage:n,Server:Se(this.instance),StreamId:"default_rejection_streamId"})},e.prototype.pushDataToSingle=function(e,t,n){if("object"!==typeof n)throw new Error("Invalid arguments. Data must be an object.");this.sendResult({EventStreamAction:5,EventStreamSubject:t.privateEventStreamSubject,MethodName:e.protocolState.method.Method.Name,MethodRequestSubject:e.protocolState.method.MethodRequestSubject,ResultContextJson:n,Server:Se(this.instance),StreamId:t.streamId})},e.prototype.closeSingleSubscription=function(e,t){this.closeIndividualSubscription(e,t.streamId,t.privateEventStreamSubject,!0)},e.prototype.acceptRequestOnBranch=function(e,t,n){"string"!==typeof n&&(n="");var r=this.getStreamId(t,n),o=e.msg;this.sendResult({EventStreamAction:3,EventStreamSubject:t.protocolState.globalEventStreamSubject,InvocationId:o.Context.InvocationId,MethodName:t.protocolState.method.Method.Name,MethodRequestSubject:t.protocolState.method.MethodRequestSubject,MethodResponseSubject:o.MethodResponseSubject,MethodVersion:t.protocolState.method.Method.Version,ResultMessage:"Accepted",Server:Se(this.instance),StreamId:r})},e.prototype.processSubscriberMsg=function(e,t){e&&e.EventStreamAction&&0!==e.EventStreamAction&&(1===e.EventStreamAction?this.clientWishesToSubscribe(e,t):2===e.EventStreamAction?this.clientWishesToUnsubscribe(e,t):3===e.EventStreamAction?this.clientAcknowledgesItDidSubscribe(e,t):4===e.EventStreamAction&&this.clientPerSubHeartbeat(e))},e.prototype.sendResult=function(e){if("object"!==typeof e)throw new Error("Invalid message.");"number"!==typeof e.Status&&(e.Status=0),this.connection.send("agm","MethodInvocationResultMessage",e)},e.prototype.clientWishesToSubscribe=function(e,t){var n={msg:e,arguments:e.Context.ArgumentsJson||{},instance:ye(e.Client)};"function"===typeof this.requestHandler&&this.requestHandler(n,t)},e.prototype.clientWishesToUnsubscribe=function(e,t){t&&Array.isArray(t.protocolState.subscriptions)&&t.protocolState.subscriptions.length>0&&this.closeIndividualSubscription(t,e.StreamId,e.EventStreamSubject,!1)},e.prototype.clientAcknowledgesItDidSubscribe=function(e,t){if("string"===typeof e.StreamId&&""!==e.StreamId){var n=this.getBranchKey(t,e.StreamId);if("string"===typeof n&&Array.isArray(t.protocolState.subscriptions)){var r={branchKey:n,instance:ye(e.Client),arguments:e.Context.ArgumentsJson,streamId:e.StreamId,privateEventStreamSubject:e.EventStreamSubject,methodResponseSubject:e.MethodResponseSubject};t.protocolState.subscriptions.push(r),"function"===typeof this.subAddedHandler&&this.subAddedHandler(r,t)}}},e.prototype.clientPerSubHeartbeat=function(e){},e.prototype.getBranchKey=function(e,t){if("string"===typeof t&&"object"===typeof e){var n=e.protocolState.branchKeyToStreamIdMap.filter((function(e){return e.streamId===t}))[0];if("object"===typeof n&&"string"===typeof n.key)return n.key}},e.prototype.getStreamId=function(e,t){"string"!==typeof t&&(t="");var n=e.protocolState.branchKeyToStreamIdMap.filter((function(e){return e.key===t}))[0],r=n?n.streamId:void 0;return"string"===typeof r&&""!==r||(r=this.generateNewStreamId(e.protocolState.method.Method.Name),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:r})),r},e.prototype.closeIndividualSubscription=function(e,t,n,r){var o=e.protocolState.subscriptions.filter((function(e){return e.privateEventStreamSubject===n&&e.streamId===t}))[0];if("object"===typeof o){var i=e.protocolState.subscriptions.length;e.protocolState.subscriptions=e.protocolState.subscriptions.filter((function(e){return!(e.privateEventStreamSubject===o.privateEventStreamSubject&&e.streamId===o.streamId)})),e.protocolState.subscriptions.length===i-1&&(!0===r&&this.sendResult({EventStreamAction:2,EventStreamSubject:n,MethodName:e.protocolState.method.Method.Name,MethodRequestSubject:e.protocolState.method.MethodRequestSubject,MethodResponseSubject:o.methodResponseSubject,MethodVersion:e.protocolState.method.Method.Version,ResponseContextJson:{},Server:Se(this.instance),StreamId:o.streamId,Status:0}),"function"===typeof this.subRemovedHandler&&this.subRemovedHandler(o,e))}},e.prototype.getUniqueBranchNames=function(e){var t=e.protocolState.subscriptions.map((function(e){var t=null;return"object"===typeof e&&"string"===typeof e.branchKey&&(t=e.branchKey),t})),n=[];return t.filter((function(e){return!(null===e||n.indexOf(e)>=0)&&(n.push(e),!0)}))},e}(),Me=function(){function e(e,t,n,r){var o=this;this.connection=e,this.instance=t,this.serverRepository=r,this.invocationMessagesMap={},this.reqCounter=0,this.callbacks=O(),this.streaming=new Ie(e,t),e.on("agm","MethodInvocationRequestMessage",(function(e){return o.handleMethodInvocationMessage(e)})),e.disconnected(this.stopTimers.bind(this)),this.sendHeartbeat(),void 0===this.heartbeatTimer&&(this.heartbeatTimer=setInterval((function(){return o.sendHeartbeat()}),5e3)),this.getBranchList=this.streaming.getBranchList,this.getSubscriptionList=this.streaming.getSubscriptionList,this.closeAllSubscriptions=this.streaming.closeAllSubscriptions,this.closeSingleSubscription=this.streaming.closeSingleSubscription,this.pushDataToSingle=this.streaming.pushDataToSingle,this.pushData=this.streaming.pushData,this.onSubRequest=this.streaming.onSubRequest,this.acceptRequestOnBranch=this.streaming.acceptRequestOnBranch,this.rejectRequest=this.streaming.rejectRequest,this.onSubAdded=this.streaming.onSubAdded,this.onSubRemoved=this.streaming.onSubRemoved}return e.prototype.stopTimers=function(){clearInterval(this.presenceTimer),clearInterval(this.heartbeatTimer)},e.prototype.unregister=function(e){return this.sendPresence(),Promise.resolve()},e.prototype.register=function(e){var t=this.nextRequestSubject();return e.protocolState.method=this.createNewMethodMessage(e.definition,t,!1),this.announceNewMethod(),Promise.resolve()},e.prototype.createStream=function(e){var t=this.nextRequestSubject(),n=this.createNewMethodMessage(e.definition,t,!0);return e.protocolState.method=n,e.protocolState.globalEventStreamSubject=e.definition.name+".jsStream."+z(),e.protocolState.subscriptions=[],e.protocolState.branchKeyToStreamIdMap=[],this.announceNewMethod(),Promise.resolve()},e.prototype.onInvoked=function(e){this.callbacks.add("onInvoked",e)},e.prototype.methodInvocationResult=function(e,t,n,r){var o=this.invocationMessagesMap[t];if(o&&"null"!==o.MethodResponseSubject&&void 0!==e){var i={MethodRequestSubject:o.MethodRequestSubject,MethodResponseSubject:o.MethodResponseSubject,MethodName:e.protocolState.method.Method.Name,InvocationId:t,ResultContextJson:r,Server:Se(this.instance),ResultMessage:n,Status:n?1:0};this.connection.send("agm","MethodInvocationResultMessage",i),delete this.invocationMessagesMap[t]}},e.prototype.nextRequestSubject=function(){return"req_"+this.reqCounter+++"_"+z()},e.prototype.sendHeartbeat=function(){this.connection.send("agm","ServerHeartbeatMessage",this.constructHeartbeat())},e.prototype.constructHeartbeat=function(){return{PublishingInterval:5e3,Instance:Se(this.instance)}},e.prototype.constructPresence=function(){var e=this.serverRepository.getList();return{PublishingInterval:1e4,Instance:Se(this.instance),MethodDefinitions:e.map((function(e){return e.protocolState.method}))}},e.prototype.sendPresence=function(){this.connection.send("agm","ServerPresenceMessage",this.constructPresence())},e.prototype.announceNewMethod=function(){var e=this;this.sendPresence(),void 0===this.presenceTimer&&(this.presenceTimer=setInterval((function(){return e.sendPresence()}),1e4))},e.prototype.handleMethodInvocationMessage=function(e){var t=e.MethodRequestSubject,n=this.serverRepository.getList().filter((function(e){return e.protocolState.method.MethodRequestSubject===t}))[0];if(void 0!==n)if(this.streaming.isStreamMsg(e,n))this.streaming.processSubscriberMsg(e,n);else{var r=e.Context.InvocationId;this.invocationMessagesMap[r]=e;var o={args:e.Context.ArgumentsJson,instance:ye(e.Client)};this.callbacks.execute("onInvoked",n,r,o)}},e.prototype.createNewMethodMessage=function(e,t,n){return"string"===typeof e&&(e={name:e}),"number"!==typeof e.version&&(e.version=0),{Method:{Name:e.name,InputSignature:e.accepts,ResultSignature:e.returns,Description:e.description,DisplayName:e.displayName,Version:e.version,ObjectTypeRestrictions:e.objectTypes,Flags:n?32:void 0},MethodRequestSubject:t}},e}(),je=function(){function e(e,t,n,r){this.configuration=e,this.instance=t,this.sendRequest=n,this.nextResponseSubject=r,this.subscriptionsList={}}return e.prototype.subscribe=function(e,t,n,r,o,i){var s=this;if(0!==n.length){var a="subscriptionId_"+z(),c=this.registerSubscription(a,e,t,o,i,r.methodResponseTimeout);"object"===typeof c?n.forEach((function(n){var o=s.nextResponseSubject(),i=e.info.requestSubject;c.trackedServers.push({server:void 0,streamId:void 0,streamSubjects:{global:void 0,private:void 0},methodRequestSubject:i,methodResponseSubject:o});var u={EventStreamAction:1,MethodRequestSubject:i,MethodResponseSubject:o,Client:Se(s.instance),Context:{ArgumentsJson:t.arguments,InvocationId:a,MethodName:e.info.name,ExecutionServer:n.server.info,Timeout:r.methodResponseTimeout}};s.sendRequest(u)})):i({method:e.getInfoForUser(),message:"Subscription failed. Unable to register the user callbacks.",called_with:t.arguments})}else i({method:e.getInfoForUser(),message:"Subscription failed. No available servers matched the target params.",called_with:t.arguments})},e.prototype.processPublisherMsg=function(e){e&&e.EventStreamAction&&0!==e.EventStreamAction&&(2===e.EventStreamAction?this.serverIsKickingASubscriber(e):3===e.EventStreamAction?this.serverAcknowledgesGoodSubscription(e):5===e.EventStreamAction&&this.serverHasPushedSomeDataIntoTheStream(e))},e.prototype.registerSubscription=function(e,t,n,r,o,i){var s=this;return this.subscriptionsList[e]={status:"awaitingAccept",method:t,params:n,success:r,error:o,trackedServers:[],handlers:{onData:[],onClosed:[]},queued:{data:[],closers:[]},timeoutId:void 0},this.subscriptionsList[e].timeoutId=setTimeout((function(){if(void 0!==s.subscriptionsList[e]){var r=s.subscriptionsList[e];if("awaitingAccept"===r.status)o({method:t,called_with:n.arguments,message:"Subscription failed. Subscription attempt timed out after "+i+"ms."}),delete s.subscriptionsList[e];else if("subscribed"===r.status&&r.trackedServers.length>0&&(r.trackedServers=r.trackedServers.filter((function(e){return"string"===typeof e.streamId&&""!==e.streamId})),r.timeoutId=void 0,0===r.trackedServers.length)){var a=r.queued.closers.length,c=a>0?r.queued.closers[a-1]:null;r.handlers.onClosed.forEach((function(e){"function"===typeof e&&e({message:"ServerInitiated",requestArguments:r.params.arguments,server:c,stream:r.method})})),delete s.subscriptionsList[e]}}}),i),this.subscriptionsList[e]},e.prototype.serverIsKickingASubscriber=function(e){var t=this,n=Object.keys(this.subscriptionsList);"string"===typeof e.InvocationId&&""!==e.InvocationId&&(n=n.filter((function(t){return t===e.InvocationId})));var r=[];n.forEach((function(n){"object"===typeof t.subscriptionsList[n]&&(t.subscriptionsList[n].trackedServers=t.subscriptionsList[n].trackedServers.filter((function(t){var n=t.methodRequestSubject===e.MethodRequestSubject&&t.methodResponseSubject===e.MethodResponseSubject,r=t.streamId===e.StreamId&&(t.streamSubjects.global===e.EventStreamSubject||t.streamSubjects.private===e.EventStreamSubject);return!(n||r)})),0===t.subscriptionsList[n].trackedServers.length&&r.push(n))})),r.forEach((function(n){if("object"===typeof t.subscriptionsList[n]){if("awaitingAccept"===t.subscriptionsList[n].status&&"number"===typeof t.subscriptionsList[n].timeoutId){var r="string"===typeof e.ResultMessage&&""!==e.ResultMessage?' Publisher said "'+e.ResultMessage+'".':" No reason given.",o="object"===typeof t.subscriptionsList[n].params.arguments?JSON.stringify(t.subscriptionsList[n].params.arguments):"{}";t.subscriptionsList[n].error("Subscription rejected."+r+" Called with:"+o),clearTimeout(t.subscriptionsList[n].timeoutId)}else t.subscriptionsList[n].handlers.onClosed.forEach((function(r){"function"===typeof r&&r({message:"ServerInitiated",requestArguments:t.subscriptionsList[n].params.arguments,server:ye(e.Server),stream:t.subscriptionsList[n].method})}));delete t.subscriptionsList[n]}}))},e.prototype.serverAcknowledgesGoodSubscription=function(e){var t=this,n=e.InvocationId,r=this.subscriptionsList[n];if("object"===typeof r){var o=r.trackedServers.filter((function(t){return t.methodRequestSubject===e.MethodRequestSubject&&t.methodResponseSubject===e.MethodResponseSubject}))[0];if("object"===typeof o){var i="awaitingAccept"===r.status;r.status="subscribed";var s=this.generatePrivateStreamSubject(r.method.name);if("string"!==typeof o.streamId||""===o.streamId){o.server=ye(e.Server),o.streamId=e.StreamId,o.streamSubjects.global=e.EventStreamSubject,o.streamSubjects.private=s;var a={EventStreamAction:3,EventStreamSubject:s,StreamId:e.StreamId,MethodRequestSubject:e.MethodRequestSubject,MethodResponseSubject:o.methodResponseSubject,Client:Se(this.instance),Context:{ArgumentsJson:r.params.arguments,MethodName:r.method.name}};this.sendRequest(a),i&&r.success({onData:function(e){if("function"!==typeof e)throw new TypeError("The data callback must be a function.");this.handlers.onData.push(e),1===this.handlers.onData.length&&this.queued.data.length>0&&this.queued.data.forEach((function(t){e(t)}))}.bind(r),onClosed:function(e){if("function"!==typeof e)throw new TypeError("The callback must be a function.");this.handlers.onClosed.push(e)}.bind(r),onFailed:function(){},close:function(){return t.closeSubscription(r,n)},requestArguments:r.params.arguments,serverInstance:ye(e.Server),stream:r.method})}}}},e.prototype.serverHasPushedSomeDataIntoTheStream=function(e){var t=function(t){if(n.subscriptionsList.hasOwnProperty(t)&&"object"===typeof n.subscriptionsList[t]){var r=void 0,o=n.subscriptionsList[t].trackedServers.filter((function(t){return t.streamId===e.StreamId&&(t.streamSubjects.global===e.EventStreamSubject||t.streamSubjects.private===e.EventStreamSubject)}));if(0===o.length?r=void 0:o[0].streamSubjects.global===e.EventStreamSubject?r=!1:o[0].streamSubjects.private===e.EventStreamSubject&&(r=!0),void 0!==r){var i={data:e.ResultContextJson,server:ye(e.Server),requestArguments:n.subscriptionsList[t].params.arguments||{},message:e.ResultMessage,private:r},s=n.subscriptionsList[t].handlers.onData,a=n.subscriptionsList[t].queued.data;Array.isArray(s)&&(s.length>0?s.forEach((function(e){"function"===typeof e&&e(i)})):a.push(i))}}},n=this;for(var r in this.subscriptionsList)t(r)},e.prototype.closeSubscription=function(e,t){var n=this,r=this.nextResponseSubject();e.trackedServers.forEach((function(e){n.sendRequest({EventStreamAction:2,Client:Se(n.instance),MethodRequestSubject:e.methodRequestSubject,MethodResponseSubject:r,StreamId:e.streamId,EventStreamSubject:e.streamSubjects.private})})),e.handlers.onClosed.forEach((function(t){"function"===typeof t&&t({message:"ClientInitiated",requestArguments:e.arguments||{},server:e.trackedServers[e.trackedServers.length-1].server,stream:e.method})})),delete this.subscriptionsList[t]},e.prototype.generatePrivateStreamSubject=function(e){return"ESSpriv-jsb_"+Se(this.instance).ApplicationName+"_on_"+e+"_"+z()},e}();function _e(e,t){return void 0===e&&(e=0),new Promise((function(n,r){return setTimeout((function(){return r(t)}),e)}))}!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(we||(we={}));var ke=function(){function e(e,t,n,r){this.protocol=e,this.repo=t,this.instance=n,this.configuration=r}return e.prototype.subscribe=function(e,t,n,r,o){var i=this,s=function(e,n,r,s){var a;t.methodResponseTimeout=null!==(a=t.methodResponseTimeout)&&void 0!==a?a:t.waitTimeoutMs,i.protocol.client.subscribe(n,t,e,{methodResponseTimeout:t.waitTimeoutMs},r,s,o)};return le(new Promise((function(n,r){var o,a=function(e){n(e)},c=function(e){r(e)};if(e)if((o="string"===typeof e?{name:e}:e).name){void 0===t&&(t={});var u=t.target;if(void 0===u&&(u="best"),"string"!==typeof u||"all"===u||"best"===u){void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=i.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=i.configuration.waitTimeoutMs));var d=0,p=i.getServerMethodsByFilterAndTarget(o,u);if(p.length>0)s(p,p[0].methods[0],a,c);else{var f=function(){if(d+=500,(p=i.getServerMethodsByFilterAndTarget(o,u)).length>0){var n=p[0].methods[0];s(p,n,a,c)}else if(d>=t.waitTimeoutMs){s(p,{id:void 0,info:"string"===typeof e?{name:e}:e,getInfoForUser:function(){return o},protocolState:void 0},a,c)}else setTimeout(f,500)};setTimeout(f,500)}}else r(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else r("Method definition is required. Please, provide either a unique string for a method name or a \u201cmethodDefinition\u201d object with a required \u201cname\u201d property.");else r("Method definition is required. Please, provide either a unique string for a method name or a \u201cmethodDefinition\u201d object with a required \u201cname\u201d property.")})),n,r)},e.prototype.servers=function(e){var t=void 0===e?void 0:s({},e);return this.getServers(t).map((function(e){return e.server.getInfoForUser()}))},e.prototype.methods=function(e){var t=s({},e);return this.getMethods(t).map((function(e){return e.getInfoForUser()}))},e.prototype.methodsForInstance=function(e){return this.getMethodsForInstance(e).map((function(e){return e.getInfoForUser()}))},e.prototype.methodAdded=function(e){return this.repo.onMethodAdded((function(t){e(t.getInfoForUser())}))},e.prototype.methodRemoved=function(e){return this.repo.onMethodRemoved((function(t){e(t.getInfoForUser())}))},e.prototype.serverAdded=function(e){return this.repo.onServerAdded((function(t){e(t.getInfoForUser())}))},e.prototype.serverRemoved=function(e){return this.repo.onServerRemoved((function(t,n){e(t.getInfoForUser(),n)}))},e.prototype.serverMethodAdded=function(e){return this.repo.onServerMethodAdded((function(t,n){e({server:t.getInfoForUser(),method:n.getInfoForUser()})}))},e.prototype.serverMethodRemoved=function(e){return this.repo.onServerMethodRemoved((function(t,n){e({server:t.getInfoForUser(),method:n.getInfoForUser()})}))},e.prototype.invoke=function(e,t,n,r,o,i){return a(this,void 0,void 0,(function(){var u=this;return c(this,(function(d){return[2,le(function(){return a(u,void 0,void 0,(function(){var o,i,a,u,d,p,f,h=this;return c(this,(function(c){switch(c.label){case 0:if(!(o="string"===typeof e?{name:e}:s({},e)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a \u201cmethodDefinition\u201d object with a required \u201cname\u201d property.")];if(t||(t={}),n||(n="best"),"string"===typeof n&&"all"!==n&&"best"!==n&&"skipMine"!==n)return[2,Promise.reject(new Error('"'+n+'" is not a valid target. Valid targets are "all" and "best".'))];if(r||(r={}),void 0===r.methodResponseTimeoutMs&&(r.methodResponseTimeoutMs=r.method_response_timeout,void 0===r.methodResponseTimeoutMs&&(r.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===r.waitTimeoutMs&&(r.waitTimeoutMs=r.wait_for_method_timeout,void 0===r.waitTimeoutMs&&(r.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==r.waitTimeoutMs&&"number"!==typeof r.waitTimeoutMs)return[2,Promise.reject(new Error('"'+r.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!==typeof t)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+o.name))];if(0!==(i=this.getServerMethodsByFilterAndTarget(o,n)).length)return[3,4];c.label=1;case 1:return c.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(o,n,r)];case 2:return i=c.sent(),[3,4];case 3:return c.sent(),a={method:o,called_with:t,message:"Can not find a method matching "+JSON.stringify(e)+" with server filter "+JSON.stringify(n)+". Is the object a valid instance ?",executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(a)];case 4:return u=r.methodResponseTimeoutMs,d=i.map((function(e){var n=z();return Promise.race([h.protocol.client.invoke(n,e.methods[0],t,e.server,r),_e(u,{invocationId:n,message:"Invocation timeout ("+u+" ms) reached",status:we.Error})])})),[4,Promise.all(d)];case 5:return p=c.sent(),f=this.getInvocationResultObj(p,o,t),p.every((function(e){return e.status===we.Error}))?[2,Promise.reject(f)]:[2,f]}}))}))}(),o,i)]}))}))},e.prototype.getInvocationResultObj=function(e,t,n){var r=e.filter((function(e){return e.status===we.Success})).reduce((function(e,r){return e=u(e,[{executed_by:r.instance,returned:r.result,called_with:n,method:t,message:r.message,status:r.status}])}),[]),o=e.filter((function(e){return e.status===we.Error})).reduce((function(e,r){return e=u(e,[{executed_by:r.instance,called_with:n,name:t.name,message:r.message}])}),[]),i=e[0];return{method:t,called_with:n,returned:i.result,executed_by:i.instance,all_return_values:r,all_errors:o,message:i.message,status:i.status}},e.prototype.tryToAwaitForMethods=function(e,t,n){var r=this;return new Promise((function(o,i){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=r.getServerMethodsByFilterAndTarget(e,t);if(c.length>0)clearInterval(a),o(c);else if(s>=n.waitTimeoutMs)return clearInterval(a),void i()}),500);else i()}))},e.prototype.filterByTarget=function(e,t){var n=this;if("string"!==typeof e){return(Array.isArray(e)?e:[e]).reduce((function(e,r){var o=t.filter((function(e){return n.instanceMatch(r,e.server.info)}));return e.concat(o)}),[])}if("all"===e)return u(t);if("best"===e){var r=t.find((function(e){return e.server.info.isLocal}));if(r)return[r];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter((function(e){return e.server.getInfoForUser().peerId!==n.instance.peerId}));return[]},e.prototype.instanceMatch=function(e,t){return this.containsProps(e,t)},e.prototype.methodMatch=function(e,t){return this.containsProps(e,t)},e.prototype.containsProps=function(e,t){return Object.keys(e).filter((function(t){return void 0!==e[t]&&"function"!==typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"_"!==t[0]})).reduce((function(n,r){var o=e[r],i=t[r];if("objectTypes"===r){(o.length>i.length||!1===function(e,t){var n=e.reduce((function(e,t){return e[t]=!1,e}),{});t.forEach((function(e){void 0!==n[e]&&(n[e]=!0)}));return Object.keys(n).reduce((function(e,t){return n[t]||(e=!1),e}),!0)}(o,i))&&(n=!1)}else String(o).toLowerCase()!==String(i).toLowerCase()&&(n=!1);return n}),!0)},e.prototype.getMethods=function(e){var t=this;return void 0===e?this.repo.getMethods():("string"===typeof e&&(e={name:e}),this.repo.getMethods().filter((function(n){return t.methodMatch(e,n.info)})))},e.prototype.getMethodsForInstance=function(e){var t=this,n=this.repo.getServers().filter((function(n){return t.instanceMatch(e,n.info)}));if(0===n.length)return[];var r={};return 1===n.length?r=n[0].methods:n.forEach((function(e){Object.keys(e.methods).forEach((function(t){var n=e.methods[t];r[n.id]=n}))})),Object.keys(r).map((function(e){return r[e]}))},e.prototype.getServers=function(e){var t=this,n=this.repo.getServers();return void 0===e?n.map((function(e){return{server:e}})):n.reduce((function(n,r){var o=t.repo.getServerMethodsById(r.id).filter((function(n){return t.methodMatch(e,n.info)}));return o.length>0&&n.push({server:r,methods:o}),n}),[])},e.prototype.getServerMethodsByFilterAndTarget=function(e,t){var n=this.getServers(e);return this.filterByTarget(t,n)},e}(),xe=function(){function e(e,t,n,r){var o=this;this.connection=e,this.instance=t,this.configuration=n,this.repository=r,this.respCounter=0,this.callbacks=O(),this.timers={},this._pendingCallbacks={},this.timers={},this.streaming=new je(n,t,(function(t){e.send("agm","MethodInvocationRequestMessage",t)}),(function(){return o.nextResponseSubject()})),this.listenForEvents()}return e.prototype.subscribe=function(e,t,n,r,o,i){this.streaming.subscribe(e,t,n,r,o,i)},e.prototype.onInvocationResult=function(e){this.callbacks.add("onResult",e)},e.prototype.invoke=function(e,t,n,r,o){var i=this,s=z(),a=t.info,c={MethodRequestSubject:a.requestSubject,MethodResponseSubject:this.nextResponseSubject(),Client:Se(this.instance),Context:{ArgumentsJson:n,InvocationId:s,MethodName:a.name,ExecutionServer:r.info,Timeout:o.methodResponseTimeoutMs}};return this.onInvocationResult((function(e,t,n,r,o){return i.processInvocationResult(e,t,n,r,o)})),new Promise((function(e,r){i._pendingCallbacks[s]={invocationInfo:{method:t,calledWith:n},success:function(t){return e(t)},error:function(e){return r(e)}},i.connection.send("agm","MethodInvocationRequestMessage",c)}))},e.prototype.drainSubscriptions=function(){return[]},e.prototype.nextResponseSubject=function(){return"resp_"+this.respCounter+++"_"+z()},e.prototype.createServerInfo=function(e){return{machine:e.MachineName,pid:e.ProcessId,user:e.UserName,application:e.ApplicationName,environment:e.Environment,region:e.Region}},e.prototype.createMethod=function(e){var t=e.Method;return{name:t.Name,accepts:t.InputSignature,returns:t.ResultSignature,requestSubject:e.MethodRequestSubject,description:t.Description,displayName:t.DisplayName,version:t.Version,objectTypes:t.ObjectTypeRestrictions,supportsStreaming:be(t.Flags)}},e.prototype.createServerId=function(e){if(void 0!==e)return[e.application,e.user,e.machine,e.started,e.pid].join("/").toLowerCase()},e.prototype.processServerPresence=function(e,t){var n=e.Instance,r=this.createServerInfo(n),o=this.createServerId(r);if(t)o=this.repository.addServer(r,o),e.PublishingInterval&&this.scheduleTimeout(o,e.PublishingInterval);else if(0===e.PublishingInterval){"undefined"!==typeof this.repository.getServerById(o)&&this.repository.removeServerById(o)}void 0!==e.MethodDefinitions&&this.updateServerMethods(o,e.MethodDefinitions)},e.prototype.scheduleTimeout=function(e,t){var n=this;if(-1!==t){var r=this.timers[e];void 0!==r&&clearTimeout(r),this.timers[e]=setTimeout((function(){n.repository.removeServerById(e)}),4*t)}},e.prototype.updateServerMethods=function(e,t){var n=this,r=this.repository.getServerMethodsById(e),o=t.map((function(e){return n.createMethod(e)})).reduce((function(e,t){return e[n.repository.createMethodId(t)]=t,e}),{});r.forEach((function(t){void 0===o[t.id]?n.repository.removeServerMethod(e,t.id):delete o[t.id]})),Object.keys(o).forEach((function(t){var r=o[t];n.repository.addServerMethod(e,r)}))},e.prototype.handleInvokeResultMessage=function(e){if(e&&e.EventStreamAction&&0!==e.EventStreamAction)this.streaming.processPublisherMsg(e);else{var t=e.Server?this.createServerInfo(e.Server):void 0,n=e.ResultContextJson;n&&0===Object.keys(n).length&&(n=void 0),this.callbacks.execute("onResult",e.InvocationId,t,e.Status,n,e.ResultMessage)}},e.prototype.listenForEvents=function(){var e=this;this.connection.on("agm","ServerPresenceMessage",(function(t){e.processServerPresence(t,!0)})),this.connection.on("agm","ServerHeartbeatMessage",(function(t){e.processServerPresence(t,!1)})),this.connection.on("agm","MethodInvocationResultMessage",(function(t){e.handleInvokeResultMessage(t)}))},e.prototype.processInvocationResult=function(e,t,n,r,o){var i=this._pendingCallbacks[e];void 0!==i&&(n===we.Success&&"function"===typeof i.success?i.success({invocationId:e,instance:t,result:r,message:o,status:we.Success}):"function"===typeof i.error&&i.error({invocationId:e,instance:t,result:r,message:o,status:we.Error}),delete this._pendingCallbacks[e])},e}();var Te=function(){function e(e,t,n,r){var o=this;this.session=e,this.repository=t,this.serverRepository=n,this.logger=r,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=O(),this.nextStreamId=0,e.on("add-interest",(function(e){o.handleAddInterest(e)})),e.on("remove-interest",(function(e){o.handleRemoveInterest(e)}))}return e.prototype.acceptRequestOnBranch=function(e,t,n){if("string"!==typeof n&&(n=""),"object"!==typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var r=this.getStreamId(t,n),o=e.msg.subscription_id,i={id:o,arguments:e.arguments,instance:e.instance,branchKey:n,streamId:r,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[o]=i,this.session.sendFireAndForget({type:"accepted",subscription_id:o,stream_id:r}),this.callbacks.execute("onSubscriptionAdded",i,t)},e.prototype.rejectRequest=function(e,t,n){"string"!==typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,e.msg.subscription_id)},e.prototype.pushData=function(e,t,n){var r=this;if("object"===typeof e&&Array.isArray(e.protocolState.branchKeyToStreamIdMap)){if("object"!==typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"===typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=null),e.protocolState.branchKeyToStreamIdMap.filter((function(e){return null===n||Boolean(e)&&"string"===typeof e.key&&n.indexOf(e.key)>=0})).map((function(e){return e.streamId})).forEach((function(e){var n={type:"publish",stream_id:e,data:t};r.session.sendFireAndForget(n)}))}},e.prototype.pushDataToSingle=function(e,t,n){if("object"!==typeof n)throw new Error("Invalid arguments. Data must be an object.");var r={type:"post",subscription_id:t.id,data:n};this.session.sendFireAndForget(r)},e.prototype.closeSingleSubscription=function(e,t){delete e.protocolState.subscriptionsMap[t.id];var n={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);t.instance;this.callbacks.execute("onSubscriptionRemoved",t,e)},e.prototype.closeMultipleSubscriptions=function(e,t){var n=this;if("object"===typeof e&&"object"===typeof e.protocolState.subscriptionsMap){var r=Object.keys(e.protocolState.subscriptionsMap).map((function(t){return e.protocolState.subscriptionsMap[t]}));"string"===typeof t&&(r=r.filter((function(e){return e.branchKey===t}))),r.forEach((function(t){delete e.protocolState.subscriptionsMap[t.id];var r={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping all subscriptions on stream_id: "+t.streamId};n.session.sendFireAndForget(r)}))}},e.prototype.getSubscriptionList=function(e,t){if("object"!==typeof e)return[];var n=Object.keys(e.protocolState.subscriptionsMap).map((function(t){return e.protocolState.subscriptionsMap[t]}));return"string"!==typeof t?n:n.filter((function(e){return e.branchKey===t}))},e.prototype.getBranchList=function(e){if("object"!==typeof e)return[];var t=Object.keys(e.protocolState.subscriptionsMap).map((function(t){return e.protocolState.subscriptionsMap[t]})).map((function(e){var t=null;return"object"===typeof e&&"string"===typeof e.branchKey&&(t=e.branchKey),t})),n=[];return t.filter((function(e){return!(null===e||n.indexOf(e)>=0)&&(n.push(e),!0)}))},e.prototype.onSubAdded=function(e){this.onSubscriptionLifetimeEvent("onSubscriptionAdded",e)},e.prototype.onSubRequest=function(e){this.onSubscriptionLifetimeEvent("onSubscriptionRequest",e)},e.prototype.onSubRemoved=function(e){this.onSubscriptionLifetimeEvent("onSubscriptionRemoved",e)},e.prototype.handleRemoveInterest=function(e){var t=this.serverRepository.getById(e.method_id);if("string"===typeof e.subscription_id&&"object"===typeof t&&"object"===typeof t.protocolState.subscriptionsMap[e.subscription_id]){var n=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute("onSubscriptionRemoved",n,t)}},e.prototype.onSubscriptionLifetimeEvent=function(e,t){this.callbacks.add(e,t)},e.prototype.getNextStreamId=function(){return this.nextStreamId+++""},e.prototype.handleAddInterest=function(e){var t=this.repository.getServerById(e.caller_id),n="function"===typeof t.getInfoForUser?t.getInfoForUser():null,r={msg:e,arguments:e.arguments_kv||{},instance:n},o=this.serverRepository.getById(e.method_id);if(void 0!==o)o.protocolState.subscriptionsMap&&o.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute("onSubscriptionRequest",r,o);else{var i="No method with id "+e.method_id+" on this server.";this.sendSubscriptionFailed(i,e.subscription_id)}},e.prototype.sendSubscriptionFailed=function(e,t){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(n)},e.prototype.getStreamId=function(e,t){"string"!==typeof t&&(t="");var n=e.protocolState.branchKeyToStreamIdMap.filter((function(e){return e.key===t}))[0],r=n?n.streamId:void 0;return"string"===typeof r&&""!==r||(r=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:r})),r},e}(),Re=function(){function e(e,t,n,r){var o=this;this.session=e,this.clientRepository=t,this.serverRepository=n,this.logger=r,this.callbacks=O(),this.streaming=new Te(e,t,n,r),this.session.on("invoke",(function(e){return o.handleInvokeMessage(e)}))}return e.prototype.createStream=function(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)},e.prototype.register=function(e,t){var n=this,r=e.definition,o={streaming:t||!1},i={type:"register",methods:[{id:e.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:o,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(i,{methodId:e.repoId}).then((function(){n.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)})).catch((function(t){throw n.logger.warn("failed to register method "+e.definition.name+" with id "+e.repoId+" - "+JSON.stringify(t)),t}))},e.prototype.onInvoked=function(e){this.callbacks.add("onInvoked",e)},e.prototype.methodInvocationResult=function(e,t,n,r){var o;o=n||""===n?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:n,context:r,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:r,request_id:void 0},this.session.sendFireAndForget(o)},e.prototype.unregister=function(e){return a(this,void 0,void 0,(function(){var t;return c(this,(function(n){switch(n.label){case 0:return t={type:"unregister",methods:[e.repoId]},[4,this.session.send(t)];case 1:return n.sent(),[2]}}))}))},e.prototype.getBranchList=function(e){return this.streaming.getBranchList(e)},e.prototype.getSubscriptionList=function(e,t){return this.streaming.getSubscriptionList(e,t)},e.prototype.closeAllSubscriptions=function(e,t){this.streaming.closeMultipleSubscriptions(e,t)},e.prototype.pushData=function(e,t,n){this.streaming.pushData(e,t,n)},e.prototype.pushDataToSingle=function(e,t,n){this.streaming.pushDataToSingle(e,t,n)},e.prototype.closeSingleSubscription=function(e,t){this.streaming.closeSingleSubscription(e,t)},e.prototype.acceptRequestOnBranch=function(e,t,n){this.streaming.acceptRequestOnBranch(e,t,n)},e.prototype.rejectRequest=function(e,t,n){this.streaming.rejectRequest(e,t,n)},e.prototype.onSubRequest=function(e){this.streaming.onSubRequest(e)},e.prototype.onSubAdded=function(e){this.streaming.onSubAdded(e)},e.prototype.onSubRemoved=function(e){this.streaming.onSubRemoved(e)},e.prototype.handleInvokeMessage=function(e){var t=e.invocation_id,n=e.caller_id,r=e.method_id,o=e.arguments_kv,i=this.serverRepository.getList().filter((function(e){return e.repoId===r}))[0];if(void 0!==i){var s={args:o,instance:this.clientRepository.getServerById(n).getInfoForUser()};this.callbacks.execute("onInvoked",i,t,s)}},e}(),Ae=function(){function e(e,t){this.repository=e,this.subscriptionData=t}return Object.defineProperty(e.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"servers",{get:function(){var e=this;return this.subscriptionData.trackedServers.filter((function(e){return e.subscriptionId})).map((function(t){return e.repository.getServerById(t.serverId).getInfoForUser()}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stream",{get:function(){return this.subscriptionData.method.info},enumerable:!0,configurable:!0}),e.prototype.onData=function(e){if("function"!==typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(t){e(t)}))},e.prototype.onClosed=function(e){if("function"!==typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)},e.prototype.onFailed=function(e){},e.prototype.onConnected=function(e){if("function"!==typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)},e.prototype.close=function(){this.subscriptionData.close()},e.prototype.setNewSubscription=function(e){this.subscriptionData=e},e}(),Ee=function(){function e(e,t,n){var r=this;this.session=e,this.repository=t,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(e){var t=e._tag,n=t.subLocalKey,o=r.subscriptionsList[n];if("object"===typeof o&&(o.trackedServers=o.trackedServers.filter((function(e){return e.serverId!==t.serverId})),o.trackedServers.length<=0)){if(clearTimeout(o.timeoutId),"awaitingAccept"===o.status){var i="string"===typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",s="object"===typeof o.params.arguments?JSON.stringify(o.params.arguments):"{}";o.error({message:"Subscription rejected."+i+" Called with:"+s,called_with:o.params.arguments,method:o.method.getInfoForUser()})}else"subscribed"===o.status&&r.callOnClosedHandlers(o);delete r.subscriptionsList[n]}},this.handleSubscribed=function(e){var t=e._tag.subLocalKey,n=r.subscriptionsList[t];if("object"===typeof n){var o=e._tag.serverId,i=n.trackedServers.filter((function(e){return e.serverId===o}))[0];if("object"===typeof i){i.subscriptionId=e.subscription_id,r.subscriptionIdToLocalKeyMap[e.subscription_id]=t;var s="awaitingAccept"===n.status;if(n.status="subscribed",s){var a=!!n.subscription;if(a)n.subscription.setNewSubscription(n),n.success(n.subscription);else{var c=new Ae(r.repository,n);n.subscription=c,n.success(c)}n.handlers.onConnected.forEach((function(e){var t;try{e(null===(t=n.subscription)||void 0===t?void 0:t.serverInstance,a)}catch(r){}}))}}}},this.handleEventData=function(e){var t=r.subscriptionIdToLocalKeyMap[e.subscription_id];if("undefined"!==typeof t){var n=r.subscriptionsList[t];if("object"===typeof n){var o=n.trackedServers.filter((function(t){return t.subscriptionId===e.subscription_id}));if(1===o.length){var i=e.oob,s=o[0].serverId,a=function(){return{data:e.data,server:r.repository.getServerById(s).getInfoForUser(),requestArguments:n.params.arguments,message:null,private:i}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(e){"function"===typeof e&&e(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(e){var t=r.subscriptionIdToLocalKeyMap[e.subscription_id];if("undefined"!==typeof t){var n=r.subscriptionsList[t];if("object"===typeof n){var o=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(t){return t.subscriptionId!==e.subscription_id||(n.queued.closers.push(t.serverId),!1)})),n.trackedServers.length===o&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),r.callOnClosedHandlers(n),delete r.subscriptionsList[t]),delete r.subscriptionIdToLocalKeyMap[e.subscription_id])}}},e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}return e.prototype.subscribe=function(e,t,n,r,o,i,s){var a=this;if(0!==n.length){var c=this.getNextSubscriptionLocalKey(),u=this.registerSubscription(c,e,t,o,i,r.methodResponseTimeout,s);"object"===typeof u?n.forEach((function(n){var r=n.server.id,o=n.methods.find((function(t){return t.info.name===e.info.name}));u.trackedServers.push({serverId:r,subscriptionId:void 0});var i={type:"subscribe",server_id:r,method_id:o.protocolState.id,arguments_kv:t.arguments};a.session.send(i,{serverId:r,subLocalKey:c}).then((function(e){return a.handleSubscribed(e)})).catch((function(e){return a.handleErrorSubscribing(e)}))})):i({method:e.getInfoForUser(),called_with:t.arguments,message:"Subscription failed. Unable to register the user callbacks."})}else i({method:e.getInfoForUser(),called_with:t.arguments,message:"Subscription failed. No available servers matched the target params."})},e.prototype.drainSubscriptions=function(){var e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e},e.prototype.getNextSubscriptionLocalKey=function(){var e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e},e.prototype.registerSubscription=function(e,t,n,r,o,i,s){var a=this,c={localKey:e,status:"awaitingAccept",method:t,params:n,success:r,error:o,trackedServers:[],handlers:{onData:(null===s||void 0===s?void 0:s.handlers.onData)||[],onClosed:(null===s||void 0===s?void 0:s.handlers.onClosed)||[],onConnected:(null===s||void 0===s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(e)},subscription:null===s||void 0===s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[e]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[e]){var r=a.subscriptionsList[e];"awaitingAccept"===r.status?(o({method:t.getInfoForUser(),called_with:n.arguments,message:"Subscription failed. Subscription attempt timed out after "+i+" ms."}),delete a.subscriptionsList[e]):"subscribed"===r.status&&r.trackedServers.length>0&&(r.trackedServers=r.trackedServers.filter((function(e){return"undefined"!==typeof e.subscriptionId})),delete r.timeoutId,r.trackedServers.length<=0&&(a.callOnClosedHandlers(r),delete a.subscriptionsList[e]))}}),i),c},e.prototype.callOnClosedHandlers=function(e,t){var n=e.queued.closers.length,r=n>0?e.queued.closers[n-1]:null,o=null;void 0!==r&&"string"===typeof r&&(o=this.repository.getServerById(r).getInfoForUser()),e.handlers.onClosed.forEach((function(n){"function"===typeof n&&n({message:t||"ServerInitiated",requestArguments:e.params.arguments,server:o,stream:e.method})}))},e.prototype.closeSubscription=function(e){var t=this,n=this.subscriptionsList[e];"object"===typeof n&&(n.trackedServers.forEach((function(e){"undefined"!==typeof e.subscriptionId&&(n.queued.closers.push(e.serverId),t.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:"ClientInitiated"}),delete t.subscriptionIdToLocalKeyMap[e.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,"ClientInitiated"),delete this.subscriptionsList[e])},e}(),Oe=function(){function e(e,t,n){var r=this;this.session=e,this.repository=t,this.logger=n,this.callbacks=O(),e.on("peer-added",(function(e){return r.handlePeerAdded(e)})),e.on("peer-removed",(function(e){return r.handlePeerRemoved(e)})),e.on("methods-added",(function(e){return r.handleMethodsAddedMessage(e)})),e.on("methods-removed",(function(e){return r.handleMethodsRemovedMessage(e)})),this.streaming=new Ee(e,t,n)}return e.prototype.subscribe=function(e,t,n,r,o,i,s){this.streaming.subscribe(e,t,n,r,o,i,s)},e.prototype.invoke=function(e,t,n,r){var o=this,i=r.id,s={type:"call",server_id:i,method_id:t.protocolState.id,arguments_kv:n};return this.session.send(s,{invocationId:e,serverId:i}).then((function(e){return o.handleResultMessage(e)})).catch((function(e){return o.handleInvocationError(e)}))},e.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},e.prototype.handlePeerAdded=function(e){var t=e.new_peer_id,n=e.identity,r=!e.meta||e.meta.local,o=Number(n.process),i={machine:n.machine,pid:isNaN(o)?n.process:o,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:t,api:n.api,isLocal:r};this.repository.addServer(i,t)},e.prototype.handlePeerRemoved=function(e){var t=e.removed_id,n=e.reason;this.repository.removeServerById(t,n)},e.prototype.handleMethodsAddedMessage=function(e){var t=this,n=e.server_id;e.methods.forEach((function(e){var r={name:e.name,displayName:e.display_name,description:e.description,version:e.version,objectTypes:e.object_types||[],accepts:e.input_signature,returns:e.result_signature,supportsStreaming:"undefined"!==typeof e.flags&&e.flags.streaming};t.repository.addServerMethod(n,r,{id:e.id})}))},e.prototype.handleMethodsRemovedMessage=function(e){var t=this,n=e.server_id,r=e.methods,o=this.repository.getServerById(n);Object.keys(o.methods).forEach((function(e){var i=o.methods[e];r.indexOf(i.protocolState.id)>-1&&t.repository.removeServerMethod(n,e)}))},e.prototype.handleResultMessage=function(e){var t=e._tag.invocationId,n=e.result,r=e._tag.serverId;return{invocationId:t,result:n,instance:this.repository.getServerById(r).getInfoForUser(),status:we.Success,message:""}},e.prototype.handleInvocationError=function(e){this.logger.debug("handle invocation error "+JSON.stringify(e));var t=e._tag.invocationId,n=e._tag.serverId,r=this.repository.getServerById(n),o=e.reason;return{invocationId:t,result:e.context,instance:r.getInfoForUser(),status:we.Error,message:o}},e}();function Ce(e,t,n,r,o,i){var s,a=o.logger.subLogger("gw3-protocol"),c=new Promise((function(e){s=e})),u=t.domain("agm",a.subLogger("domain"),["subscribed"]),d=new Re(u,n,r,a.subLogger("server")),p=new Oe(u,n,a.subLogger("client"));return u.onLeft((function(){n.reset()})),u.onJoined((function(o){n.addServer(e,t.peerId),o?function(){a.info("reconnected - will replay registered methods and subscriptions"),p.drainSubscriptions().forEach((function(e){var t=e.method.info,n=Object.assign({},e.params);i().client.subscribe(t,n,void 0,void 0,e)}));var e=r.getList();r.reset();for(var t=0,n=e;t<n.length;t++){var o=n[t],s=o.definition;o.stream?i().server.createStream(s,o.streamCallbacks,void 0,void 0,o.stream):o.theFunction.userCallback?i().register(s,o.theFunction.userCallback):o.theFunction.userCallbackAsync&&i().registerAsync(s,o.theFunction.userCallbackAsync)}}():(s({client:p,server:d}),s=void 0)})),u.join(),c}var Ne=function(){function e(e,t,n){this.protocol=e,this.repoMethod=t,this.subscription=n}return Object.defineProperty(e.prototype,"stream",{get:function(){return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"instance",{get:function(){return this.subscription.instance},enumerable:!0,configurable:!0}),e.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},e.prototype.push=function(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)},e}(),Pe=function(){function e(e,t,n){this.protocol=e,this.repoMethod=t,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return e.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},e.prototype.acceptOnBranch=function(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)},e.prototype.reject=function(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)},e}(),Le=function(){function e(e,t){var n=this;this.protocol=e,this.server=t,e.server.onSubRequest((function(e,t){return n.handleSubRequest(e,t)})),e.server.onSubAdded((function(e,t){return n.handleSubAdded(e,t)})),e.server.onSubRemoved((function(e,t){return n.handleSubRemoved(e,t)}))}return e.prototype.handleSubRequest=function(e,t){if(t&&t.streamCallbacks&&"function"===typeof t.streamCallbacks.subscriptionRequestHandler){var n=new Pe(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(n)}},e.prototype.handleSubAdded=function(e,t){if(t&&t.streamCallbacks&&"function"===typeof t.streamCallbacks.subscriptionAddedHandler){var n=new Ne(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(n)}},e.prototype.handleSubRemoved=function(e,t){if(t&&t.streamCallbacks&&"function"===typeof t.streamCallbacks.subscriptionRemovedHandler){var n=new Ne(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(n)}},e}(),qe=function(){function e(e,t,n){this.key=e,this.protocol=t,this.repoMethod=n}return e.prototype.subscriptions=function(){var e=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(t){return new Ne(e.protocol,e.repoMethod,t)}))},e.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},e.prototype.push=function(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])},e}(),De=function(){function e(e,t,n){this._protocol=e,this._repoMethod=t,this._server=n,this.name=this._repoMethod.definition.name}return e.prototype.branches=function(e){var t=this,n=this._protocol.server.getBranchList(this._repoMethod);return e?n.indexOf(e)>-1?new qe(e,this._protocol,this._repoMethod):void 0:n.map((function(e){return new qe(e,t._protocol,t._repoMethod)}))},e.prototype.subscriptions=function(){var e=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(t){return new Ne(e._protocol,e._repoMethod,t)}))},Object.defineProperty(e.prototype,"definition",{get:function(){var e=this._repoMethod.definition;return{accepts:e.accepts,description:e.description,displayName:e.displayName,name:e.name,objectTypes:e.objectTypes,returns:e.returns,supportsStreaming:e.supportsStreaming}},enumerable:!0,configurable:!0}),e.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},e.prototype.push=function(e,t){if("string"!==typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!==typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)},e.prototype.updateRepoMethod=function(e){this._repoMethod=e},e}(),Fe=function(){function e(e,t){this.protocol=e,this.serverRepository=t,this.invocations=0,this.currentlyUnregistering={},this.streaming=new Le(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return e.prototype.createStream=function(e,t,n,r,o){var i=this;return le(new Promise((function(n,r){if(e){var a;if(!(a="string"===typeof e?{name:""+e}:s({},e)).name)return r("The \u201cname\u201d property is required for the \u201cstreamDefinition\u201d object and must be unique. Stream definition: "+JSON.stringify(a));if(i.serverRepository.getList().some((function(e){return e.definition.name===a.name})))return r('A stream with the name "'+a.name+'" already exists! Please, provide a unique name for the stream.');a.supportsStreaming=!0,t||(t={}),"function"!==typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=function(e){e.accept()});var c={definition:a,streamCallbacks:t,protocolState:{}};i.serverRepository.add(c),i.protocol.server.createStream(c).then((function(){var e;o?(e=o,o.updateRepoMethod(c)):e=new De(i.protocol,c,i),c.stream=e,n(e)})).catch((function(e){i.serverRepository.remove(c.repoId),r(e)}))}else r("The stream name must be unique! Please, provide either a unique string for a stream name to \u201cglue.interop.createStream()\u201d or a \u201cmethodDefinition\u201d object with a unique \u201cname\u201d property for the stream.")})),n,r)},e.prototype.register=function(e,t){var n=this;if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a \u201cmethodDefinition\u201d object with a required \u201cname\u201d property.");if("function"!==typeof t)return Promise.reject("The second parameter must be a callback function. Method: "+("string"===typeof e?e:e.name));var r=function(e,r){return a(n,void 0,void 0,(function(){var n,o,i;return c(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(n=t(e.args,e.instance))&&"function"===typeof n.then?[4,n]:[3,2];case 1:return o=s.sent(),r(null,o),[3,3];case 2:r(null,n),s.label=3;case 3:return[3,5];case 4:return(i=s.sent())||(i=""),r(i,i),[3,5];case 5:return[2]}}))}))};return r.userCallback=t,this.registerCore(e,r)},e.prototype.registerAsync=function(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a \u201cmethodDefinition\u201d object with a required \u201cname\u201d property.");if("function"!==typeof t)return Promise.reject("The second parameter must be a callback function. Method: "+("string"===typeof e?e:e.name));var n=function(e,n){try{var r=!1,o=function(e){r||n(null,e),r=!0},i=function(e){r||(e||(e=""),n(e,e)),r=!0},s=t(e.args,e.instance,o,i);s&&"function"===typeof s.then&&s.then(o).catch(i)}catch(a){n(a,null)}};return n.userCallbackAsync=t,this.registerCore(e,n)},e.prototype.unregister=function(e,t){return void 0===t&&(t=!1),a(this,void 0,void 0,(function(){var n,r;return c(this,(function(o){switch(o.label){case 0:return void 0===e?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a \u201cname\u201d property.")]:"function"!==typeof e?[3,2]:[4,this.unregisterWithPredicate(e,t)];case 1:return o.sent(),[2];case 2:return void 0===(n="string"===typeof e?{name:e}:e).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(r=this.serverRepository.getList().find((function(e){return e.definition.name===n.name&&(e.definition.supportsStreaming||!1)===t})))?[4,this.removeMethodsOrStreams([r])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return o.sent(),[2]}}))}))},e.prototype.unregisterWithPredicate=function(e,t){return a(this,void 0,void 0,(function(){var n;return c(this,(function(r){switch(r.label){case 0:return(n=this.serverRepository.getList().filter((function(t){return e(t.definition)})).filter((function(e){return(e.definition.supportsStreaming||!1)===t})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(t?"stream":"method")+" matching the specified condition!")];case 1:return r.sent(),[2]}}))}))},e.prototype.removeMethodsOrStreams=function(e){var t=this,n=[];return e.forEach((function(e){var r=t.protocol.server.unregister(e).then((function(){t.serverRepository.remove(e.repoId)}));n.push(r),t.addAsCurrentlyUnregistering(e.definition.name,r)})),Promise.all(n)},e.prototype.addAsCurrentlyUnregistering=function(e,t){return a(this,void 0,void 0,(function(){var n,r=this;return c(this,(function(o){return n=new Promise((function(e){return setTimeout(e,5e3)})),this.currentlyUnregistering[e]=Promise.race([t,n]).then((function(){var t,n;t=r.currentlyUnregistering,n=e,Object.keys(t).reduce((function(e,r){return r!==n&&(e[r]=t[r]),e}),{})})),[2]}))}))},e.prototype.registerCore=function(e,t){return a(this,void 0,void 0,(function(){var n,r,o,i=this;return c(this,(function(a){switch(a.label){case 0:return(n="string"===typeof e?{name:""+e}:s({},e)).name?(r=this.currentlyUnregistering[n.name])?[4,r]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the \u201cname\u201d property in the \u201cmethodDefinition\u201d object: "+JSON.stringify(e))];case 1:a.sent(),a.label=2;case 2:return this.serverRepository.getList().some((function(e){return e.definition.name===n.name}))?[2,Promise.reject('A method with the name "'+n.name+'" already exists! Please, provide a unique name for the method.')]:n.supportsStreaming?[2,Promise.reject("When you create methods with \u201cglue.interop.register()\u201d or \u201cglue.interop.registerAsync()\u201d the property \u201csupportsStreaming\u201d cannot be \u201ctrue\u201d. If you want \u201c"+n.name+"\u201d to be a stream, please use the \u201cglue.interop.createStream()\u201d method.")]:(o=this.serverRepository.add({definition:n,theFunction:t,protocolState:{}}),[2,this.protocol.server.register(o).catch((function(e){throw i.serverRepository.remove(o.repoId),e}))])}}))}))},e.prototype.containsProps=function(e,t){var n=Object.keys(e).filter((function(t){return"function"!==typeof e[t]&&"object_types"!==t&&"display_name"!==t})),r=Object.keys(t);return Array.from(new Set(u(n,r))).reduce((function(n,r){var o=e[r],i=t[r];if("supportsStreaming"===r&&(i=i||!1,o=o||!1),"objectTypes"===r&&void 0!==o&&void 0!==i)if(o.length!==i.length)n=!1;else{var s=o.sort(),a=i.sort();s.some((function(e,t){return e!==a[t]}))&&(n=!1)}else o!==i&&(n=!1);return n}),!0)},e.prototype.onMethodInvoked=function(e,t,n){var r=this;e&&e.theFunction(n,(function(n,o){if(void 0!==n&&null!==n)if(n.message&&"string"===typeof n.message)n=n.message;else if("string"!==typeof n)try{n=JSON.stringify(n)}catch(i){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}o&&"object"===typeof o&&o.constructor!==Array||(o={_result:o}),r.protocol.server.methodInvocationResult(e,t,n,o)}))},e}(),Ue=function(){function e(e,t,n,r,o){this.client=new ke(e,t,r,o),this.server=new Fe(e,n),this.instance=r}return e.prototype.serverRemoved=function(e){return this.client.serverRemoved(e)},e.prototype.serverAdded=function(e){return this.client.serverAdded(e)},e.prototype.serverMethodRemoved=function(e){return this.client.serverMethodRemoved(e)},e.prototype.serverMethodAdded=function(e){return this.client.serverMethodAdded(e)},e.prototype.methodRemoved=function(e){return this.client.methodRemoved(e)},e.prototype.methodAdded=function(e){return this.client.methodAdded(e)},e.prototype.methodsForInstance=function(e){return this.client.methodsForInstance(e)},e.prototype.methods=function(e){return this.client.methods(e)},e.prototype.servers=function(e){return this.client.servers(e)},e.prototype.subscribe=function(e,t,n,r){return this.client.subscribe(e,t,n,r)},e.prototype.createStream=function(e,t,n,r){return this.server.createStream(e,t,n,r)},e.prototype.unregister=function(e){return this.server.unregister(e)},e.prototype.registerAsync=function(e,t){return this.server.registerAsync(e,t)},e.prototype.register=function(e,t){return this.server.register(e,t)},e.prototype.invoke=function(e,t,n,r,o,i){return this.client.invoke(e,t,n,r,o,i)},e.prototype.updateInstance=function(e){void 0===this.instance.machine&&(this.instance.machine=e.MachineName||e.machine),void 0===this.instance.user&&(this.instance.user=e.UserName||e.user),void 0===this.instance.environment&&(this.instance.environment=e.Environment||e.environment),void 0===this.instance.region&&(this.instance.region=e.Region||e.region)},e}(),Je=function(){function e(){this.servers={},this.methodsCount={},this.callbacks=O()}return e.prototype.addServer=function(e,t){var n=this.servers[t];if(n)return n.id;var r={id:t,info:e,methods:{},getInfoForUser:function(){return new pe(r.info).unwrap()}};return this.servers[t]=r,this.callbacks.execute("onServerAdded",r),t},e.prototype.removeServerById=function(e,t){var n=this,r=this.servers[e];Object.keys(r.methods).forEach((function(t){n.removeServerMethod(e,t)})),delete this.servers[e],this.callbacks.execute("onServerRemoved",r,t)},e.prototype.addServerMethod=function(e,t,n){n||(n={});var r=this.servers[e];if(!r)throw new Error("server does not exists");var o=this.createMethodId(t);if(!r.methods[o]){var i=this,s={id:o,info:t,getInfoForUser:function(){var e=i.createUserMethodInfo(s.info);return e.getServers=function(){return i.getServersByMethod(o)},e},protocolState:n};r.methods[o]=s,this.methodsCount[o]||(this.methodsCount[o]=0,this.callbacks.execute("onMethodAdded",s)),this.methodsCount[o]=this.methodsCount[o]+1,this.callbacks.execute("onServerMethodAdded",r,s)}},e.prototype.createMethodId=function(e){var t=void 0!==e.accepts?e.accepts:"",n=void 0!==e.returns?e.returns:"";return(e.name+t+n).toLowerCase()},e.prototype.removeServerMethod=function(e,t){var n=this.servers[e];if(!n)throw new Error("server does not exists");var r=n.methods[t];delete n.methods[t],this.methodsCount[t]=this.methodsCount[t]-1,0===this.methodsCount[t]&&this.callbacks.execute("onMethodRemoved",r),this.callbacks.execute("onServerMethodRemoved",n,r)},e.prototype.getMethods=function(){var e=this,t={};return Object.keys(this.servers).forEach((function(n){var r=e.servers[n];Object.keys(r.methods).forEach((function(e){var n=r.methods[e];t[n.id]=n}))})),Object.keys(t).map((function(e){return t[e]}))},e.prototype.getServers=function(){var e=this,t=[];return Object.keys(this.servers).forEach((function(n){var r=e.servers[n];t.push(r)})),t},e.prototype.getServerMethodsById=function(e){var t=this.servers[e];return Object.keys(t.methods).map((function(e){return t.methods[e]}))},e.prototype.onServerAdded=function(e){var t=this.callbacks.add("onServerAdded",e),n=this.getServers();return this.returnUnsubWithDelayedReplay(t,n,e)},e.prototype.onMethodAdded=function(e){var t=this.callbacks.add("onMethodAdded",e),n=this.getMethods();return this.returnUnsubWithDelayedReplay(t,n,e)},e.prototype.onServerMethodAdded=function(e){var t=this.callbacks.add("onServerMethodAdded",e),n=!1,r=this.getServers();return setTimeout((function(){r.forEach((function(t){var r=t.methods;Object.keys(r).forEach((function(o){n||e(t,r[o])}))}))}),0),function(){n=!0,t()}},e.prototype.onMethodRemoved=function(e){return this.callbacks.add("onMethodRemoved",e)},e.prototype.onServerRemoved=function(e){return this.callbacks.add("onServerRemoved",e)},e.prototype.onServerMethodRemoved=function(e){return this.callbacks.add("onServerMethodRemoved",e)},e.prototype.getServerById=function(e){return this.servers[e]},e.prototype.reset=function(){var e=this;Object.keys(this.servers).forEach((function(t){e.removeServerById(t,"reset")})),this.servers={},this.methodsCount={}},e.prototype.createUserServerInfo=function(e){return{machine:e.machine,pid:e.pid,user:e.user,application:e.application,applicationName:e.applicationName,environment:e.environment,region:e.region,instance:e.instance,windowId:e.windowId,peerId:e.peerId,isLocal:e.isLocal,api:e.api}},e.prototype.createUserMethodInfo=function(e){var t={name:e.name,accepts:e.accepts,returns:e.returns,description:e.description,displayName:e.displayName,objectTypes:e.objectTypes,supportsStreaming:e.supportsStreaming};return t.object_types=e.objectTypes,t.display_name=e.displayName,t.version=e.version,t},e.prototype.getServersByMethod=function(e){var t=this,n=[];return Object.keys(this.servers).forEach((function(r){var o=t.servers[r];Object.keys(o.methods).forEach((function(t){t===e&&n.push(o.getInfoForUser())}))})),n},e.prototype.returnUnsubWithDelayedReplay=function(e,t,n){var r=!1;return setTimeout((function(){t.forEach((function(e){r||n(e)}))}),0),function(){r=!0,e()}},e}(),Ve=function(){function e(){this.nextId=0,this.methods=[]}return e.prototype.add=function(e){if("object"===typeof e&&void 0===e.repoId)return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e},e.prototype.remove=function(e){if("string"!==typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(t){return t.repoId!==e}))},e.prototype.getById=function(e){if("string"===typeof e)return this.methods.filter((function(t){return t.repoId===e}))[0]},e.prototype.getList=function(){return this.methods.map((function(e){return e}))},e.prototype.length=function(){return this.methods.length},e.prototype.reset=function(){this.methods=[]},e}(),He=function(e){if(!e.forceGW&&2===e.gdVersion)return function(e){var t=window.htmlContainer.jsAgmFacade,n=ge(e);return new Promise((function(e,r){var o=function(n){var r=new me(n,new ve(t),t);r.create_stream=r.createStream,r.methods_for_instance=r.methodsForInstance,r.method_added=r.methodAdded,r.method_removed=r.methodRemoved,r.server_added=r.serverAdded,r.server_removed=r.serverRemoved,r.server_method_added=r.serverMethodAdded,r.server_method_removed=r.serverMethodRemoved,e(r)};t.protocolVersion&&t.protocolVersion>=5&&t.initAsync?t.initAsync(n,o,(function(e){r(e)})):o(t.init(n))}))}(e);if("undefined"===typeof e)throw new Error("configuration is required");if("undefined"===typeof e.connection)throw new Error("configuration.connections is required");var t=e.connection;"number"!==typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!==typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4);var n,r,o=new Je,i=new Ve,s=new pe(e.instance,t);return n=3===t.protocolVersion?Ce(s.unwrap(),t,o,i,e,(function(){return r})):function(e,t,n,r,o,i){var s=t.on("agm","Instance",(function(e){i().updateInstance(e),t.off(s)})),a=new Me(t,e,o,r),c=new xe(t,e,o,n);return new Promise((function(e){e({server:a,client:c})}))}(s.unwrap(),t,o,i,e,(function(){return r})),new Promise((function(t,a){n.then((function(n){r=new Ue(n,o,i,s.unwrap(),e),pe.API=r,t(r)})).catch((function(e){a(e)}))}))};function Be(e){var t={};return Object.keys(e).forEach((function(n){void 0!==e[n]&&null!==e[n]&&(t[n]=e[n])})),t}var Ke=function(e,t,n){var r=this;this.publish=function(e,t,n){var o=n||{},i=o.routingKey,s=o.target,a=Be({type:"publish",topic:e,data:t,peer_id:r.peerId,routing_key:i,target_identity:s});r.session.send(a)},this.subscribe=function(e,t,n){return new Promise((function(o,i){var s=n||{},a=s.routingKey,c=s.target,u=Be({type:"subscribe",topic:e,peer_id:r.peerId,routing_key:a,source:c});r.session.send(u).then((function(n){var i=n.subscription_id;r.subscriptions.push({subscription_id:i,topic:e,callback:t,source:c}),o({unsubscribe:function(){return r.session.send({type:"unsubscribe",subscription_id:i,peer_id:r.peerId}),r.subscriptions=r.subscriptions.filter((function(e){return e.subscription_id!==i})),Promise.resolve()}})})).catch((function(e){return i(e)}))}))},this.watchOnEvent=function(){r.session.on("event",(function(e){var t=e.data,n=e.subscription_id,o=e["publisher-identity"],i=r.subscriptions.find((function(e){return e.subscription_id===n}));i&&(i.source?function(e,t){var n=Object.keys(e),r=!0;return n.forEach((function(n){e[n]!==t[n]&&(r=!1)})),r}(i.source,o)&&i.callback(t,i.topic,o):i.callback(t,i.topic,o))}))},this.connection=e,this.logger=t,this.session=n,this.peerId=e.peerId,this.subscriptions=[]};var Ge=["subscribed","success"],We=function(e){var t=e.connection,n=e.logger,r=t.domain("bus",n,Ge);return new Promise((function(e,o){r.join().then((function(){var o=function(e,t,n){var r=new Ke(e,t,n);return r.watchOnEvent(),r}(t,n,r);e(o)})).catch(o)}))},Ye={get name(){return"context"},get types(){return["create-context","created","destroyed","context-created","context-added","subscribe-context","subscribed-context","unsubscribe-context","destroy-context","context-destroyed","update-context","context-updated","joined"]}};function Xe(e,t,n,i,s){var a;"undefined"!==typeof window&&(a=window),"undefined"!==typeof r&&(a=r),a=a||{};var c,u=z();if($.isNode()){var d=o.env._GD_STARTING_CONTEXT_;if(d)try{c=JSON.parse(d)}catch(w){}}var p=a.GLUE_CONFIG||{},f=a.GLUE_DEFAULT_CONFIG||{},h={application:n?n.containerName+"."+n.browserWindowName:i?i.applicationName:$.isNode()?c?c.applicationConfig.name:"NodeJS"+u:"undefined"!==typeof window&&"undefined"!==typeof document?(window.agm_application||document.title)+u:void 0,metrics:function(){var t="undefined"!==typeof document?document.title:"unknown";if(t=t||"none","undefined"===typeof n)return{system:"Connect.Browser",service:e.application||t,instance:"~"+u};if("undefined"!==typeof n.metricsFacade.getIdentity){var r=n.metricsFacade.getIdentity();return{system:r.system,service:r.service,instance:r.instance}}return{system:"HtmlContainer."+n.containerName,service:"JS."+n.browserWindowName,instance:"~"+n.machineName}}(),agm:{},gateway:function(){var e=3,t="ws://localhost:8385";return i&&(e=3,t=i.gwURL),$.isNode()&&c&&(e=3,t=c.gwURL),{ws:t,http:"http://localhost:8385",protocolVersion:e,reconnectInterval:1e3}}(),logger:{publish:"off",console:"error",metrics:"off"},bus:!1,auth:function(){if($.isNode()&&c)return{gatewayToken:c.gwToken}}()},l={system:g("metrics","system"),service:g("metrics","service"),instance:g("metrics","instance")},m=g("metrics","disableAutoAppSystem");function v(){return g("application")}function g(t,n){var r=p[t],o=e[t],i=f[t],s=h[t];if(n){if(r&&void 0!==r[n])return r[n];if(o&&void 0!==o[n])return o[n];if(i&&void 0!==i[n])return i[n];if(s&&void 0!==s[n])return s[n]}else{if(void 0!==r)return r;if(void 0!==o)return o;if(void 0!==i)return i;if(void 0!==s)return s}}var y=function(){var e,r=g("gateway","force");if(void 0===n||r){var a=g("gateway"),u=g("gateway","protocolVersion"),d=g("gateway","reconnectInterval"),p=g("gateway","reconnectAttempts"),f=a.ws,h=a.http,l=a.inproc;f||h||l||($.isNode()||"WebSocket"in window&&2===window.WebSocket.CLOSING?f=g("gateway","ws"):h=g("gateway","http"));var m=void 0,y=void 0,b=void 0,S=void 0,w=void 0,I=v(),M=I;n?(y=n.windowId,S=n.env.env,w=n.env.region):"undefined"!==typeof i?(y=i.windowId,b=i.pid,i.env&&(S=i.env.env,w=i.env.region),M=null!==(e=i.application)&&void 0!==e?e:"glue-app",m=i.appInstanceId):$.isNode()&&(b=o.pid,c&&(S=c.env,w=c.region,m=c.instanceId));var j=g("gateway","replaySpecs")||[];return j.push(Ye),{identity:{application:M,applicationName:I,windowId:y,instance:m,process:b,region:w,environment:S,api:t.version||"4.8.6"},reconnectInterval:d,ws:f,http:h,gw:l,protocolVersion:u,reconnectAttempts:p,force:!0,replaySpecs:j,gdVersion:s}}return{gdVersion:s}}(),b=function(e){if(e.protocolVersion<3)return!1;var t=g("contexts");return!("boolean"===typeof t&&!t)}(y),S=function(e){if(!e)return!1;var t=g("channels");return!("boolean"===typeof t&&!t)}(b);return{bus:function(e){var t=g("bus");return!("boolean"!==typeof t||!t)&&(!(e.protocolVersion&&e.protocolVersion<3)&&2!==s)}(y),identity:l,auth:g("auth"),logger:function(){var e=g("logger");return"string"===typeof e?{console:e,metrics:"off",publish:"off"}:e}(),connection:y,metrics:{identity:l,disableAutoAppSystem:m},agm:function(){return t=e.agm,n={instance:{application:v()}},"boolean"!==typeof t||t?n:void 0;var t,n}(),contexts:b,channels:S,version:t.version||"4.8.6",libs:t.libs,customLogger:e.customLogger}}var ze={protocolVersion:-1,send:function(e,t,n,r,o){return Promise.resolve(void 0)},on:function(e,t,n){return{type:"1",id:1}},off:function(e){},login:function(e){},logout:function(){},loggedIn:function(e){},connected:function(e){},disconnected:function(e){},reconnect:function(){return Promise.resolve()}};function Qe(){function e(){return(new Date).getTime()}var t,n,r=e();return{get startTime(){return r},get endTime(){return t},get period(){return n},stop:function(){return t=e(),n=e()-r}}}var Ze=function(){function e(e,t,n,r){this.updateCallbacks={},this.contextId=e,this.name=t,this.isAnnounced=n,this.activityId=r,this.context={}}return e.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},e.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},e}();function $e(e,t){if(t){if(t.reset)return e=s({},t.reset);e=et(e,null);var n=t.added,r=t.updated,o=t.removed;n&&Object.keys(n).forEach((function(t){e[t]=n[t]})),r&&Object.keys(r).forEach((function(t){tt(t,e,r)})),o&&o.forEach((function(t){delete e[t]}))}return e}function et(e,t){if(t=t||new WeakMap,Object(e)!==e)return e;if(e instanceof Set)return new Set(e);if(t.has(e))return t.get(e);var n=e instanceof Date?new Date(e):e instanceof RegExp?new RegExp(e.source,e.flags):e.constructor?new e.constructor:Object.create(null);return t.set(e,n),Object.assign.apply(Object,u([n],Object.keys(e).map((function(n){var r;return(r={})[n]=et(e[n],t),r}))))}var tt=function(e,t,n){var r=n[e];if(void 0===r)return t;var o=t[e];return o&&r?"string"===typeof o||"number"===typeof o||"boolean"===typeof o||"string"===typeof r||"number"===typeof r||"boolean"===typeof r||Array.isArray(o)||Array.isArray(r)?(t[e]=r,t):(t[e]=Object.assign({},o,r),t):(t[e]=r,t)};function nt(e,t){if(e===t)return!0;if(!(e instanceof Object)||!(t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(var n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n]){if("object"!==typeof e[n])return!1;if(!nt(e[n],t[n]))return!1}}for(var n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}var rt=function(){function e(e){var t=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._connection=e.connection,this._logger=e.logger,this._gw3Session=this._connection.domain("global",this._logger,["context-created","subscribed-context","context-destroyed","context-updated"]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer.drain(Ye.name,(function(e){var n=e.type;n&&("context-created"===n||"context-added"===n||"created"===n?t.handleContextCreatedMessage(e):"subscribed-context"===n||"context-updated"===n||"joined"===n?t.handleContextUpdatedMessage(e):"context-destroyed"!==n&&"destroyed"!==n||t.handleContextDestroyedMessage(e))}))}return e.prototype.dispose=function(){for(var e=0,t=this._gw3Subscriptions;e<t.length;e++){var n=t[e];this._connection.off(n)}for(var r in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(r)&&delete this._contextNameToData[r]},e.prototype.createContext=function(e,t){var n=this;return this._gw3Session.send({type:"create-context",domain:"global",name:e,data:t,lifetime:"retained"}).then((function(r){if(n._contextNameToId[e]=r.context_id,!n._contextIdToName[r.context_id]){n._contextIdToName[r.context_id]=e;var o=n._contextNameToData[e]||new Ze(r.context_id,e,!0,null);return o.isAnnounced=!0,o.name=e,o.contextId=r.context_id,n._contextNameToData[e]=o,o.context=r.data,o.sentExplicitSubscription=!0,o.context&&n.invokeUpdateCallbacks(o,o.context,null),n.update(e,t).then((function(){return r.context_id}))}return r.context_id}))},e.prototype.all=function(){var e=this;return Object.keys(this._contextNameToData).filter((function(t){return e._contextNameToData[t].isAnnounced}))},e.prototype.update=function(e,t){return a(this,void 0,void 0,(function(){var n,r,o,i=this;return c(this,(function(s){switch(s.label){case 0:return(n=this._contextNameToData[e])&&n.isAnnounced?(r=n.context,n.hasCallbacks()?[3,2]:[4,this.get(n.name,!1)]):[2,this.createContext(e,t)];case 1:r=s.sent(),s.label=2;case 2:return o=this.calculateContextDelta(r,t),Object.keys(o.added).length||Object.keys(o.updated).length||o.removed.length?[2,this._gw3Session.send({type:"update-context",domain:"global",context_id:n.contextId,delta:o},{},{skipPeerId:!1}).then((function(e){i.handleUpdated(n,o,{updaterId:e.peer_id})}))]:[2,Promise.resolve()]}}))}))},e.prototype.set=function(e,t){var n=this,r=this._contextNameToData[e];return r&&r.isAnnounced?this._gw3Session.send({type:"update-context",domain:"global",context_id:r.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then((function(e){n.handleUpdated(r,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})})):this.createContext(e,t)},e.prototype.get=function(e,t){var n=this;void 0===t&&(t=!0);var r=this._contextNameToData[e];return r&&r.isAnnounced&&r.hasCallbacks()||t?Promise.resolve(r&&r.context):new Promise((function(t,r){return a(n,void 0,void 0,(function(){var n=this;return c(this,(function(r){return this.subscribe(e,(function(e,r,o,i){n.unsubscribe(i),t(e)})),[2]}))}))}))},e.prototype.subscribe=function(e,t){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var r=this._contextNameToData[e];if(!r||!r.isAnnounced)return r=r||new Ze(void 0,e,!1,void 0),this._contextNameToData[e]=r,r.updateCallbacks[n]=t,Promise.resolve(n);var o=r.hasCallbacks();return r.updateCallbacks[n]=t,o||r.joinedActivity||r.context&&r.sentExplicitSubscription?(t(r.context,r.context,[],n),Promise.resolve(n)):this.sendSubscribe(r).then((function(){return n}))},e.prototype.unsubscribe=function(e){for(var t=0,n=Object.keys(this._contextNameToData);t<n.length;t++){var r=n[t],o=(this._contextNameToId[r],this._contextNameToData[r]);if(!o)return;var i=o.hasCallbacks();delete o.updateCallbacks[e],o.isAnnounced&&i&&!o.hasCallbacks()&&o.sentExplicitSubscription&&this.sendUnsubscribe(o),o.isAnnounced||o.hasCallbacks()||delete this._contextNameToData[r]}},e.prototype.handleUpdated=function(e,t,n){var r=e.context;e.context=$e(e.context,t),this._contextNameToData[e.name]!==e||nt(r,e.context)||this.invokeUpdateCallbacks(e,e.context,t,n)},e.prototype.subscribeToContextCreatedMessages=function(){for(var e=0,t=["context-added","context-created","created"];e<t.length;e++){var n=t[e],r=this._connection.on("js-contexts",n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(r)}},e.prototype.handleContextCreatedMessage=function(e){var t=e.type;"created"===t?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):"context-added"===t&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);var n=this._contextIdToName[e.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+e.context_id);var r=this._contextNameToData[n];if(r){if(r.isAnnounced)return;if(!r.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");r.isAnnounced=!0,r.contextId=e.context_id,r.activityId=e.activity_id,r.sentExplicitSubscription||this.sendSubscribe(r)}else this._contextNameToData[n]=r=new Ze(e.context_id,n,!0,e.activity_id)},e.prototype.subscribeToContextUpdatedMessages=function(){for(var e=0,t=["context-updated","subscribed-context","joined"];e<t.length;e++){var n=t[e],r=this._connection.on("js-contexts",n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(r)}},e.prototype.handleContextUpdatedMessage=function(e){var t=e.type,n=e.context_id,r=this._contextNameToData[this._contextIdToName[n]],o=!r||!r.isAnnounced;if("joined"===t)r?(r.contextId=n,r.isAnnounced=!0,r.activityId=e.activity_id):(r=new Ze(n,e.activity_id,!0,e.activity_id),this._contextNameToData[e.activity_id]=r,this._contextIdToName[n]=e.activity_id,this._contextNameToId[e.activity_id]=n),r.joinedActivity=!0;else if(!r||!r.isAnnounced)return void("subscribed-context"===t?((r=r||new Ze(n,e.name,!0,null)).sentExplicitSubscription=!0,this._contextNameToData[e.name]=r,this._contextIdToName[n]=e.name,this._contextNameToId[e.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var i=r.context;if("subscribed-context"===t)r.context=e.data||{};else if("joined"===t)r.context=e.context_snapshot||{};else{if("context-updated"!==t)throw new Error("Unrecognized context update message "+t);r.context=$e(r.context,e.delta)}!o&&nt(r.context,i)&&"subscribed-context"!==t||this.invokeUpdateCallbacks(r,r.context,e.delta,{updaterId:e.updater_id})},e.prototype.invokeUpdateCallbacks=function(e,t,n,r){for(var o in n=n||{added:{},updated:{},reset:{},removed:[]},e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(o))try{(0,e.updateCallbacks[o])(et(t),Object.assign({},n.added||{},n.updated||{},n.reset||{}),n.removed,parseInt(o,10),r)}catch(i){this._logger.debug("callback error: "+JSON.stringify(i))}},e.prototype.subscribeToContextDestroyedMessages=function(){for(var e=0,t=["context-destroyed","destroyed"];e<t.length;e++){var n=t[e],r=this._connection.on("js-contexts",n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(r)}},e.prototype.handleContextDestroyedMessage=function(e){var t,n;if("destroyed"===e.type){if(n=e.activity_id,!(t=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+e.activity_id)}else if(t=e.context_id,!(n=this._contextIdToName[t]))return void this._logger.error("Received 'destroyed' for unknown context: "+e.context_id);delete this._contextIdToName[t],delete this._contextNameToId[n];var r=this._contextNameToData[n];delete this._contextNameToData[n],r&&r.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+t)},e.prototype.sendSubscribe=function(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:"subscribe-context",domain:"global",context_id:e.contextId}).then((function(e){}))},e.prototype.sendUnsubscribe=function(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:"unsubscribe-context",domain:"global",context_id:e.contextId}).then((function(e){}))},e.prototype.calculateContextDelta=function(e,t){var n={added:{},updated:{},removed:[],reset:null};if(e)for(var r=0,o=Object.keys(e);r<o.length;r++){var i=o[r];-1===Object.keys(t).indexOf(i)||null===t[i]||nt(e[i],t[i])||(n.updated[i]=t[i])}for(var s=0,a=Object.keys(t);s<a.length;s++){i=a[s];e&&-1!==Object.keys(e).indexOf(i)?null===t[i]&&n.removed.push(i):null!==t[i]&&(n.added[i]=t[i])}return n},e}(),ot=function(){function e(e){this._facade=window.htmlContainer.sharedContextFacade}return e.prototype.all=function(){var e=this._facade.all();return e&&e.keys?e.keys:[]},e.prototype.update=function(e,t){return this._facade.update(e,t),Promise.resolve()},e.prototype.set=function(e,t){return this._facade.set(e,t),Promise.resolve()},e.prototype.subscribe=function(e,t){var n=null,r=this._facade.subscribe(e,(function(e,o,i){r||0===r?t(e,o,i,r):n=e}));return n&&(t(n,n,[],r),n=null),Promise.resolve(r)},e.prototype.get=function(e,t){var n=this;if(t)throw new Error("resolveImmediately not supported in HtmlContainer");return new Promise((function(t,r){return a(n,void 0,void 0,(function(){var n=this;return c(this,(function(r){return this.subscribe(e,(function(e,r){n.unsubscribe(r),t(e)})),[2]}))}))}))},e.prototype.unsubscribe=function(e){this._facade.unsubscribe(e)},e}(),it=function(){function e(e){this.config=e;try{if(2===e.gdMajorVersion){if(!window.htmlContainer.sharedContextFacade)throw new Error("Your version of HtmlContainer does not support contexts. Get version 1.46.0.0 or later to have that feature.");this._bridge=new ot(e)}else{if(3!==e.connection.protocolVersion)throw new Error("To use the Contexts library you must run in the HTML Container or using a connection to Gateway v3.");this._bridge=new rt(e)}}catch(t){throw t}}return e.prototype.all=function(){return this._bridge.all()},e.prototype.update=function(e,t){return this.checkName(e),this._bridge.update(e,t)},e.prototype.set=function(e,t){return this.checkName(e),this._bridge.set(e,t)},e.prototype.subscribe=function(e,t){var n=this;return this.checkName(e),this._bridge.subscribe(e,(function(e,r,o,i,s){return t(e,r,o,(function(){return n._bridge.unsubscribe(i)}),s)})).then((function(e){return function(){n._bridge.unsubscribe(e)}}))},e.prototype.get=function(e,t){return!1===t&&(t=!0),this._bridge.get(e,t)},e.prototype.ready=function(){return Promise.resolve(this)},e.prototype.checkName=function(e){if("string"!==typeof e||""===e)throw new Error("'name' must be non-empty string, got '"+e+"'")},e}(),st=function(e,t){var n,r,o=-1,i=Promise.resolve();"undefined"!==typeof window&&(2===(o=$.getGDMajorVersion())?n=window.htmlContainer:o>=3&&(r=window.glue42gd,i=window.gdPreloadPromise||i));var s,a,c,u,d,p,f,h=Qe(),l=Xe(e=e||{},t=t||{},n,r,o),m={};function v(e,t,n){t.initStartTime=n.startTime,t.ready?t.ready().then((function(){t.initTime=n.stop(),t.initEndTime=n.endTime})):(t.initTime=n.stop(),t.initEndTime=n.endTime),Array.isArray(e)||(e=[e]),e.forEach((function(e){m[e]=t,st[e]=t}))}function g(){if(l.metrics){var e=Qe();u=A({identity:l.metrics.identity,connection:l.metrics?s:ze,logger:c.subLogger("metrics")});var t,n=(d=l.metrics.disableAutoAppSystem?u:u.subSystem("App")).subSystem("reporting"),r={name:"features",conflation:1};d.featureMetric=function(e,o,i){if("undefined"===typeof e||""===e)throw new Error("name is mandatory");if("undefined"===typeof o||""===o)throw new Error("action is mandatory");if("undefined"===typeof i||""===i)throw new Error("payload is mandatory");t?t.update({name:e,action:o,payload:i}):t=n.objectMetric(r,{name:e,action:o,payload:i})};var o=(d.parent||d).subSystem("LogEvents");c.metricsLevel("warn",o),v("metrics",d,e)}return Promise.resolve(void 0)}function y(){var e=Qe(),t={instance:l.agm.instance,connection:s,logger:c.subLogger("interop"),forceGW:l.connection&&l.connection.force,gdVersion:o};return new Promise((function(n,r){He(t).then((function(t){a=t,de.Interop=a,v(["interop","agm"],a,e),n(l)})).catch((function(e){return r(e)}))}))}function b(){var e=l.activities&&3===s.protocolVersion;if(l.contexts||e){var t=Qe();return v("contexts",p=new it({connection:s,logger:c.subLogger("contexts"),gdMajorVersion:o}),t),p}var n=s.replayer;n&&n.drain(Ye.name,null)}function S(e){try{return e.forEach((function(e){!function(e,t){var n=Qe(),r=t(m);r&&v(e,r,n)}(e.name,e.create)})),Promise.resolve()}catch(t){return Promise.reject(t)}}function w(){if(!l.bus)return Promise.resolve(void 0);var e=Qe(),t={connection:s,logger:c.subLogger("bus")};return new Promise((function(n,r){We(t).then((function(t){v("bus",f=t,e),n()})).catch((function(e){return r(e)}))}))}return i.then((function(){var e,t,n,r,o,i=Qe(),a={identity:l.identity,getConnection:function(){return s||ze},publish:l.logger.publish||"off",console:l.logger.console||"error",metrics:l.metrics&&l.logger.metrics||"off"},u=null!==(n=null===(t=null===(e=null===l||void 0===l?void 0:l.connection)||void 0===e?void 0:e.identity)||void 0===t?void 0:t.application)&&void 0!==n?n:null===(o=null===(r=null===l||void 0===l?void 0:l.agm)||void 0===r?void 0:r.instance)||void 0===o?void 0:o.application;return v("logger",c=function(e,t,n){var r=e.identity;if(!r)throw new Error("identity is missing");var o=r.system+"\\"+r.service+"\\"+r.instance;de.Instance=o,de.GetConnection=e.getConnection;var i=new de(""+t,void 0,void 0,n);return i.publishLevel(e.publish||"off"),i.consoleLevel(e.console||"info"),i.metricsLevel(e.metrics||"off"),i.toAPIObject()}(a,u,l.customLogger),i),Promise.resolve(void 0)})).then((function(){var e=Qe();l.connection.logger=c.subLogger("connection"),s=ce(l.connection);var t=Promise.resolve(l.auth);if(l.connection&&!l.auth){var n=l.connection.protocolVersion;if(!n||1===n)return v("connection",s,e),Promise.resolve({});if(2===n)return Promise.reject("You need to provide auth information");3===n&&(t=r?r.getGWToken().then((function(e){return{gatewayToken:e}})):Promise.reject("You need to provide auth information"))}return t.then((function(e){var t;if("string"===typeof e||"number"===typeof e)t={token:e};else{if("[object Object]"!==Object.prototype.toString.call(e))throw new Error("Invalid auth object - "+JSON.stringify(e));t=e}return t})).then((function(e){return s.login(e)})).then((function(t){return t&&(t.machine&&(l.agm.instance.machine=t.machine),t.user&&(l.agm.instance.user=t.user)),v("connection",s,e),l})).catch((function(e){throw s&&s.logout(),e}))})).then((function(){return Promise.all([g(),y(),b(),w()])})).then((function(){return S(l.libs||[])})).then((function(){var e=Object.keys(m).map((function(e){var t=m[e];return t.ready?t.ready():Promise.resolve()}));return Promise.all(e)})).then((function(){var o={coreVersion:"4.8.6",version:l.version};h.stop();var i={interop:a,agm:a,metrics:d,connection:s,bus:f,logger:c,contexts:p,feedback:function(e){a&&a.invoke("T42.ACS.Feedback",e,"best")},info:o,version:l.version,userConfig:e,done:function(){return s.logout(),Promise.resolve()}};if(i.performance={get glueVer(){return l.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var e=Object.keys(i).filter((function(e){var t;return"initTimes"!==e&&"agm"!==e&&(null===(t=i[e])||void 0===t?void 0:t.initTime)})).map((function(e){return{name:e,time:i[e].initTime,startTime:i[e].initStartTime,endTime:i[e].initEndTime}}));return e.push({name:"glue",startTime:h.startTime,endTime:h.endTime,time:h.period}),e}},Object.keys(m).forEach((function(e){var t=m[e];i[e]=t})),i.config={},Object.keys(l).forEach((function(e){i.config[e]=l[e]})),t.extOptions&&Object.keys(t.extOptions).forEach((function(e){i.config[e]=t.extOptions[e]})),t.enrichGlue&&t.enrichGlue(i),n&&n.perfDataNeeded&&n.updatePerfData){var u=n.perfDataDelay||100;setTimeout((function(){n.updatePerfData(i.performance)}),u)}return r&&r.updatePerfData&&r.updatePerfData(i.performance),i})).catch((function(e){return Promise.reject({err:e,libs:m})}))};"undefined"!==typeof window&&(window.GlueCore=st),st.default=st,st.version="4.8.6",t.a=st}).call(this,n("HDXh").Buffer,n("3r9c"),n("KCCg"))}}]);